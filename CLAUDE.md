# 営業日報システム 要件定義書

## 1. システム概要

営業担当者が日次で訪問記録・課題・翌日の予定を報告し、上長が承認・コメントを行うシステム。

## 2. 機能要件

| 機能             | 説明                                |
| ---------------- | ----------------------------------- |
| **日報作成**     | 営業が日次で日報を作成・編集        |
| **訪問記録**     | 1日報につき複数の顧客訪問記録を登録 |
| **添付ファイル** | 訪問記録に資料を添付可能            |
| **Problem/Plan** | 課題・相談事項と翌日の予定を記載    |
| **上長コメント** | 上長が日報にコメントを付与          |
| **承認フロー**   | 課長→部長の2段階承認                |
| **マスタ管理**   | 顧客・営業担当者・役職のマスタ管理  |

## 3. 組織階層（2階層）

```
部長（2次上長）
  └─ 課長（1次上長）
       └─ 担当（営業）
```

## 4. 承認フロー

```
下書き → 提出済 → [課長承認] → [部長承認] → 承認完了
                      ↓              ↓
                   差戻し          差戻し
```

### ステータス遷移

| ステータス         | 説明                       | 次のアクション    |
| ------------------ | -------------------------- | ----------------- |
| `draft`            | 下書き                     | 提出              |
| `submitted`        | 提出済（課長承認待ち）     | 課長が承認/差戻し |
| `manager_approved` | 課長承認済（部長承認待ち） | 部長が承認/差戻し |
| `approved`         | 承認完了                   | -                 |
| `rejected`         | 差戻し                     | 再編集して再提出  |

## 5. エンティティ一覧

| エンティティ                    | 説明                           |
| ------------------------------- | ------------------------------ |
| **役職 (position)**             | 役職マスタ（担当/課長/部長）   |
| **営業担当者 (salesperson)**    | 営業マスタ、上長との関係を持つ |
| **顧客 (customer)**             | 顧客マスタ                     |
| **日報 (daily_report)**         | 日次の報告書本体               |
| **訪問記録 (visit_record)**     | 顧客訪問の詳細（複数行）       |
| **添付ファイル (attachment)**   | 訪問記録への添付ファイル       |
| **承認履歴 (approval_history)** | 承認・差戻しの履歴             |
| **コメント (comment)**          | 上長からのコメント             |

## 6. ER図

```mermaid
erDiagram
    POSITION {
        int id PK
        string name "役職名(担当/課長/部長)"
        int level "階層レベル(1:担当/2:課長/3:部長)"
        datetime created_at
        datetime updated_at
    }

    SALESPERSON {
        int id PK
        string name "氏名"
        string email "メールアドレス"
        int position_id FK "役職ID"
        int manager_id FK "直属上長ID(課長)"
        int director_id FK "2次上長ID(部長)"
        boolean is_active "有効フラグ"
        datetime created_at
        datetime updated_at
    }

    CUSTOMER {
        int id PK
        string name "顧客名"
        string address "住所"
        string phone "電話番号"
        string industry "業種"
        boolean is_active "有効フラグ"
        datetime created_at
        datetime updated_at
    }

    DAILY_REPORT {
        int id PK
        int salesperson_id FK "営業担当者ID"
        date report_date "報告日"
        text problem "課題・相談"
        text plan "明日やること"
        string status "ステータス"
        datetime submitted_at "提出日時"
        datetime manager_approved_at "課長承認日時"
        datetime director_approved_at "部長承認日時"
        datetime created_at
        datetime updated_at
    }

    VISIT_RECORD {
        int id PK
        int daily_report_id FK "日報ID"
        int customer_id FK "顧客ID"
        time visit_time "訪問時刻"
        text content "訪問内容"
        string result "結果"
        datetime created_at
        datetime updated_at
    }

    ATTACHMENT {
        int id PK
        int visit_record_id FK "訪問記録ID"
        string file_name "ファイル名"
        string file_path "保存パス"
        string content_type "MIMEタイプ"
        int file_size "ファイルサイズ"
        datetime created_at
    }

    APPROVAL_HISTORY {
        int id PK
        int daily_report_id FK "日報ID"
        int approver_id FK "承認者ID"
        string action "アクション(承認/差戻し)"
        text comment "コメント"
        string approval_level "承認レベル(課長/部長)"
        datetime created_at
    }

    COMMENT {
        int id PK
        int daily_report_id FK "日報ID"
        int commenter_id FK "コメント者ID(上長)"
        text content "コメント内容"
        datetime created_at
        datetime updated_at
    }

    POSITION ||--o{ SALESPERSON : "持つ"
    SALESPERSON ||--o{ SALESPERSON : "課長-担当"
    SALESPERSON ||--o{ SALESPERSON : "部長-課長"
    SALESPERSON ||--o{ DAILY_REPORT : "作成"
    SALESPERSON ||--o{ COMMENT : "コメント"
    SALESPERSON ||--o{ APPROVAL_HISTORY : "承認"
    DAILY_REPORT ||--o{ VISIT_RECORD : "含む"
    DAILY_REPORT ||--o{ COMMENT : "受ける"
    DAILY_REPORT ||--o{ APPROVAL_HISTORY : "持つ"
    CUSTOMER ||--o{ VISIT_RECORD : "訪問される"
    VISIT_RECORD ||--o{ ATTACHMENT : "持つ"
```

## 7. テーブル定義詳細

### 7.1 POSITION（役職）

| カラム名   | 型          | NULL | 説明                               |
| ---------- | ----------- | ---- | ---------------------------------- |
| id         | INT         | NO   | 主キー                             |
| name       | VARCHAR(50) | NO   | 役職名（担当/課長/部長）           |
| level      | INT         | NO   | 階層レベル（1:担当/2:課長/3:部長） |
| created_at | DATETIME    | NO   | 作成日時                           |
| updated_at | DATETIME    | NO   | 更新日時                           |

### 7.2 SALESPERSON（営業担当者）

| カラム名    | 型           | NULL | 説明                          |
| ----------- | ------------ | ---- | ----------------------------- |
| id          | INT          | NO   | 主キー                        |
| name        | VARCHAR(100) | NO   | 氏名                          |
| email       | VARCHAR(255) | NO   | メールアドレス                |
| position_id | INT          | NO   | 役職ID（FK: POSITION）        |
| manager_id  | INT          | YES  | 直属上長ID（FK: SALESPERSON） |
| director_id | INT          | YES  | 2次上長ID（FK: SALESPERSON）  |
| is_active   | BOOLEAN      | NO   | 有効フラグ                    |
| created_at  | DATETIME     | NO   | 作成日時                      |
| updated_at  | DATETIME     | NO   | 更新日時                      |

### 7.3 CUSTOMER（顧客）

| カラム名   | 型           | NULL | 説明       |
| ---------- | ------------ | ---- | ---------- |
| id         | INT          | NO   | 主キー     |
| name       | VARCHAR(200) | NO   | 顧客名     |
| address    | VARCHAR(500) | YES  | 住所       |
| phone      | VARCHAR(20)  | YES  | 電話番号   |
| industry   | VARCHAR(100) | YES  | 業種       |
| is_active  | BOOLEAN      | NO   | 有効フラグ |
| created_at | DATETIME     | NO   | 作成日時   |
| updated_at | DATETIME     | NO   | 更新日時   |

### 7.4 DAILY_REPORT（日報）

| カラム名             | 型          | NULL | 説明                            |
| -------------------- | ----------- | ---- | ------------------------------- |
| id                   | INT         | NO   | 主キー                          |
| salesperson_id       | INT         | NO   | 営業担当者ID（FK: SALESPERSON） |
| report_date          | DATE        | NO   | 報告日                          |
| problem              | TEXT        | YES  | 課題・相談                      |
| plan                 | TEXT        | YES  | 明日やること                    |
| status               | VARCHAR(20) | NO   | ステータス                      |
| submitted_at         | DATETIME    | YES  | 提出日時                        |
| manager_approved_at  | DATETIME    | YES  | 課長承認日時                    |
| director_approved_at | DATETIME    | YES  | 部長承認日時                    |
| created_at           | DATETIME    | NO   | 作成日時                        |
| updated_at           | DATETIME    | NO   | 更新日時                        |

### 7.5 VISIT_RECORD（訪問記録）

| カラム名        | 型          | NULL | 説明                         |
| --------------- | ----------- | ---- | ---------------------------- |
| id              | INT         | NO   | 主キー                       |
| daily_report_id | INT         | NO   | 日報ID（FK: DAILY_REPORT）   |
| customer_id     | INT         | NO   | 顧客ID（FK: CUSTOMER）       |
| visit_time      | TIME        | YES  | 訪問時刻                     |
| content         | TEXT        | NO   | 訪問内容                     |
| result          | VARCHAR(50) | YES  | 結果（商談中/成約/見送り等） |
| created_at      | DATETIME    | NO   | 作成日時                     |
| updated_at      | DATETIME    | NO   | 更新日時                     |

### 7.6 ATTACHMENT（添付ファイル）

| カラム名        | 型           | NULL | 説明                           |
| --------------- | ------------ | ---- | ------------------------------ |
| id              | INT          | NO   | 主キー                         |
| visit_record_id | INT          | NO   | 訪問記録ID（FK: VISIT_RECORD） |
| file_name       | VARCHAR(255) | NO   | ファイル名                     |
| file_path       | VARCHAR(500) | NO   | 保存パス                       |
| content_type    | VARCHAR(100) | NO   | MIMEタイプ                     |
| file_size       | INT          | NO   | ファイルサイズ（バイト）       |
| created_at      | DATETIME     | NO   | 作成日時                       |

### 7.7 APPROVAL_HISTORY（承認履歴）

| カラム名        | 型          | NULL | 説明                            |
| --------------- | ----------- | ---- | ------------------------------- |
| id              | INT         | NO   | 主キー                          |
| daily_report_id | INT         | NO   | 日報ID（FK: DAILY_REPORT）      |
| approver_id     | INT         | NO   | 承認者ID（FK: SALESPERSON）     |
| action          | VARCHAR(20) | NO   | アクション（approved/rejected） |
| comment         | TEXT        | YES  | コメント                        |
| approval_level  | VARCHAR(20) | NO   | 承認レベル（manager/director）  |
| created_at      | DATETIME    | NO   | 作成日時                        |

### 7.8 COMMENT（コメント）

| カラム名        | 型       | NULL | 説明                            |
| --------------- | -------- | ---- | ------------------------------- |
| id              | INT      | NO   | 主キー                          |
| daily_report_id | INT      | NO   | 日報ID（FK: DAILY_REPORT）      |
| commenter_id    | INT      | NO   | コメント者ID（FK: SALESPERSON） |
| content         | TEXT     | NO   | コメント内容                    |
| created_at      | DATETIME | NO   | 作成日時                        |
| updated_at      | DATETIME | NO   | 更新日時                        |

---

## 8. 画面定義書

### 8.1 画面一覧

| 画面ID  | 画面名               | 概要                           | アクセス権限 |
| ------- | -------------------- | ------------------------------ | ------------ |
| SCR-001 | ログイン             | システムログイン               | 全員         |
| SCR-002 | ダッシュボード       | トップページ、各種サマリー表示 | 全員         |
| SCR-010 | 日報一覧             | 日報の検索・一覧表示           | 全員         |
| SCR-011 | 日報作成             | 新規日報の作成                 | 担当者       |
| SCR-012 | 日報編集             | 日報の編集（下書き・差戻し時） | 担当者       |
| SCR-013 | 日報詳細             | 日報の閲覧・承認・コメント     | 全員         |
| SCR-020 | 承認待ち一覧         | 承認待ち日報の一覧             | 課長・部長   |
| SCR-030 | 顧客マスタ一覧       | 顧客の検索・一覧表示           | 全員         |
| SCR-031 | 顧客マスタ登録       | 顧客の新規登録                 | 課長・部長   |
| SCR-032 | 顧客マスタ編集       | 顧客の編集                     | 課長・部長   |
| SCR-040 | 営業担当者マスタ一覧 | 営業担当者の検索・一覧表示     | 課長・部長   |
| SCR-041 | 営業担当者マスタ登録 | 営業担当者の新規登録           | 部長         |
| SCR-042 | 営業担当者マスタ編集 | 営業担当者の編集               | 部長         |

### 8.2 画面遷移図

```mermaid
flowchart TD
    subgraph 認証
        SCR001[SCR-001<br>ログイン]
    end

    subgraph メイン
        SCR002[SCR-002<br>ダッシュボード]
    end

    subgraph 日報管理
        SCR010[SCR-010<br>日報一覧]
        SCR011[SCR-011<br>日報作成]
        SCR012[SCR-012<br>日報編集]
        SCR013[SCR-013<br>日報詳細]
        SCR020[SCR-020<br>承認待ち一覧]
    end

    subgraph マスタ管理
        SCR030[SCR-030<br>顧客マスタ一覧]
        SCR031[SCR-031<br>顧客マスタ登録]
        SCR032[SCR-032<br>顧客マスタ編集]
        SCR040[SCR-040<br>営業担当者一覧]
        SCR041[SCR-041<br>営業担当者登録]
        SCR042[SCR-042<br>営業担当者編集]
    end

    SCR001 --> SCR002
    SCR002 --> SCR010
    SCR002 --> SCR020
    SCR002 --> SCR030
    SCR002 --> SCR040

    SCR010 --> SCR011
    SCR010 --> SCR013
    SCR011 --> SCR010
    SCR013 --> SCR012
    SCR012 --> SCR013
    SCR020 --> SCR013

    SCR030 --> SCR031
    SCR030 --> SCR032
    SCR031 --> SCR030
    SCR032 --> SCR030

    SCR040 --> SCR041
    SCR040 --> SCR042
    SCR041 --> SCR040
    SCR042 --> SCR040
```

### 8.3 共通レイアウト

#### 8.3.1 ヘッダー

| 要素           | 説明                                       |
| -------------- | ------------------------------------------ |
| ロゴ           | システムロゴ、クリックでダッシュボードへ   |
| ナビゲーション | 日報管理、承認待ち（上長のみ）、マスタ管理 |
| ユーザー情報   | ログインユーザー名、役職                   |
| ログアウト     | ログアウトボタン                           |

#### 8.3.2 サイドバー

| 要素             | 説明             | 表示条件       |
| ---------------- | ---------------- | -------------- |
| ダッシュボード   | トップページへ   | 常時           |
| 日報一覧         | 日報一覧画面へ   | 常時           |
| 日報作成         | 日報作成画面へ   | 担当者のみ     |
| 承認待ち         | 承認待ち一覧へ   | 課長・部長のみ |
| 顧客マスタ       | 顧客一覧へ       | 常時           |
| 営業担当者マスタ | 営業担当者一覧へ | 課長・部長のみ |

#### 8.3.3 フッター

| 要素         | 説明                    |
| ------------ | ----------------------- |
| コピーライト | © 2024 営業日報システム |
| バージョン   | システムバージョン      |

### 8.4 画面詳細定義

#### SCR-001: ログイン

**基本情報**

| 項目         | 内容           |
| ------------ | -------------- |
| 画面ID       | SCR-001        |
| 画面名       | ログイン       |
| URL          | /login         |
| アクセス権限 | 未認証ユーザー |

**画面レイアウト**

```
+--------------------------------------------------+
|                                                  |
|              営業日報システム                      |
|                                                  |
|    +----------------------------------------+    |
|    |  メールアドレス                          |    |
|    |  [________________________]             |    |
|    |                                        |    |
|    |  パスワード                             |    |
|    |  [________________________]             |    |
|    |                                        |    |
|    |  [ ] ログイン状態を保持する              |    |
|    |                                        |    |
|    |         [  ログイン  ]                  |    |
|    +----------------------------------------+    |
|                                                  |
+--------------------------------------------------+
```

**入力項目**

| 項目名             | 項目ID   | 種別             | 必須 | 桁数 | 備考               |
| ------------------ | -------- | ---------------- | ---- | ---- | ------------------ |
| メールアドレス     | email    | テキスト         | ○    | 255  | メール形式チェック |
| パスワード         | password | パスワード       | ○    | 100  | マスク表示         |
| ログイン状態を保持 | remember | チェックボックス | -    | -    | -                  |

**ボタン**

| ボタン名 | 動作                                         |
| -------- | -------------------------------------------- |
| ログイン | 認証処理を実行、成功時はダッシュボードへ遷移 |

**エラーメッセージ**

| コード | メッセージ                                         |
| ------ | -------------------------------------------------- |
| E001   | メールアドレスを入力してください                   |
| E002   | パスワードを入力してください                       |
| E003   | メールアドレスまたはパスワードが正しくありません   |
| E004   | アカウントが無効です。管理者にお問い合わせください |

---

#### SCR-002: ダッシュボード

**基本情報**

| 項目         | 内容               |
| ------------ | ------------------ |
| 画面ID       | SCR-002            |
| 画面名       | ダッシュボード     |
| URL          | /dashboard         |
| アクセス権限 | 全員（ログイン済） |

**画面レイアウト**

```
+--------------------------------------------------+
| [ヘッダー]                                        |
+--------------------------------------------------+
| [サイド] |                                       |
| [バー]   |  ようこそ、○○さん                      |
|          |                                       |
|          |  +-------------+ +-------------+      |
|          |  | 今月の日報   | | 承認待ち    |      |
|          |  | 作成: 15件   | | 3件         |      |
|          |  | 提出: 12件   | | (課長のみ)  |      |
|          |  +-------------+ +-------------+      |
|          |                                       |
|          |  最近の日報                            |
|          |  +----------------------------------+ |
|          |  | 日付 | ステータス | 訪問件数     | |
|          |  |------|-----------|-------------|  |
|          |  | 1/15 | 承認完了  | 5件         |  |
|          |  | 1/14 | 課長承認済| 3件         |  |
|          |  | 1/13 | 承認完了  | 4件         |  |
|          |  +----------------------------------+ |
|          |                                       |
+--------------------------------------------------+
| [フッター]                                        |
+--------------------------------------------------+
```

**表示項目（担当者向け）**

| 項目名           | 説明                                        |
| ---------------- | ------------------------------------------- |
| 今月の日報作成数 | 当月に作成した日報の件数                    |
| 今月の日報提出数 | 当月に提出した日報の件数                    |
| 最近の日報       | 直近5件の日報（日付、ステータス、訪問件数） |

**表示項目（課長・部長向け）**

| 項目名             | 説明                       |
| ------------------ | -------------------------- |
| 承認待ち件数       | 自分が承認すべき日報の件数 |
| 部下の日報提出状況 | 当日の部下の日報提出状況   |

---

#### SCR-010: 日報一覧

**基本情報**

| 項目         | 内容                                                     |
| ------------ | -------------------------------------------------------- |
| 画面ID       | SCR-010                                                  |
| 画面名       | 日報一覧                                                 |
| URL          | /reports                                                 |
| アクセス権限 | 全員（担当者は自分の日報のみ、上長は部下の日報も閲覧可） |

**画面レイアウト**

```
+--------------------------------------------------+
| [ヘッダー]                                        |
+--------------------------------------------------+
| [サイド] |  日報一覧                    [新規作成] |
| [バー]   |                                       |
|          |  検索条件                              |
|          |  +----------------------------------+ |
|          |  | 期間: [____] 〜 [____]           | |
|          |  | 担当者: [________▼]              | |
|          |  | ステータス: [________▼]          | |
|          |  |        [検索] [クリア]           | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  検索結果: 25件                        |
|          |  +----------------------------------+ |
|          |  | □ |日付|担当者|訪問数|状態|操作 | |
|          |  |---|----|----|-----|----|----|   |
|          |  | □ |1/15|山田|  5  |承認|詳細|   |
|          |  | □ |1/14|山田|  3  |課長|詳細|   |
|          |  | □ |1/13|山田|  4  |承認|詳細|   |
|          |  +----------------------------------+ |
|          |  [< 前へ] 1 2 3 ... 10 [次へ >]       |
+--------------------------------------------------+
| [フッター]                                        |
+--------------------------------------------------+
```

**検索条件**

| 項目名       | 項目ID         | 種別     | 備考                                          |
| ------------ | -------------- | -------- | --------------------------------------------- |
| 期間（開始） | date_from      | 日付     | カレンダーピッカー                            |
| 期間（終了） | date_to        | 日付     | カレンダーピッカー                            |
| 担当者       | salesperson_id | セレクト | 上長のみ表示                                  |
| ステータス   | status         | セレクト | 全て/下書き/提出済/課長承認済/承認完了/差戻し |

**一覧表示項目**

| 項目名     | 説明             | ソート |
| ---------- | ---------------- | ------ |
| 選択       | チェックボックス | -      |
| 報告日     | 日報の対象日     | ○      |
| 担当者名   | 日報作成者       | ○      |
| 訪問件数   | 訪問記録の件数   | ○      |
| ステータス | 日報の状態       | ○      |
| 操作       | 詳細ボタン       | -      |

**ボタン**

| ボタン名 | 動作               | 表示条件   |
| -------- | ------------------ | ---------- |
| 新規作成 | 日報作成画面へ遷移 | 担当者のみ |
| 検索     | 検索条件で絞り込み | 常時       |
| クリア   | 検索条件をリセット | 常時       |
| 詳細     | 日報詳細画面へ遷移 | 常時       |

---

#### SCR-011: 日報作成

**基本情報**

| 項目         | 内容         |
| ------------ | ------------ |
| 画面ID       | SCR-011      |
| 画面名       | 日報作成     |
| URL          | /reports/new |
| アクセス権限 | 担当者       |

**画面レイアウト**

```
+--------------------------------------------------+
| [ヘッダー]                                        |
+--------------------------------------------------+
| [サイド] |  日報作成                              |
| [バー]   |                                       |
|          |  基本情報                              |
|          |  +----------------------------------+ |
|          |  | 報告日: [2024/01/15]             | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  訪問記録                    [＋追加]  |
|          |  +----------------------------------+ |
|          |  | No.1                      [削除] | |
|          |  | 顧客: [________▼]               | |
|          |  | 時刻: [__:__]                    | |
|          |  | 内容: [____________________]     | |
|          |  |       [____________________]     | |
|          |  | 結果: [________▼]               | |
|          |  | 添付: [ファイル選択] file1.pdf   | |
|          |  +----------------------------------+ |
|          |  | No.2                      [削除] | |
|          |  | ...                              | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  課題・相談（Problem）                 |
|          |  +----------------------------------+ |
|          |  | [______________________________] | |
|          |  | [______________________________] | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  明日やること（Plan）                  |
|          |  +----------------------------------+ |
|          |  | [______________________________] | |
|          |  | [______________________________] | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  [下書き保存]  [提出]  [キャンセル]    |
+--------------------------------------------------+
| [フッター]                                        |
+--------------------------------------------------+
```

**入力項目**

| 項目名       | 項目ID      | 種別           | 必須 | 桁数 | 備考            |
| ------------ | ----------- | -------------- | ---- | ---- | --------------- |
| 報告日       | report_date | 日付           | ○    | -    | デフォルト:当日 |
| 課題・相談   | problem     | テキストエリア | -    | 2000 | 複数行          |
| 明日やること | plan        | テキストエリア | -    | 2000 | 複数行          |

**訪問記録（繰り返し）**

| 項目名       | 項目ID      | 種別           | 必須 | 桁数 | 備考                               |
| ------------ | ----------- | -------------- | ---- | ---- | ---------------------------------- |
| 顧客         | customer_id | セレクト       | ○    | -    | 顧客マスタから選択                 |
| 訪問時刻     | visit_time  | 時刻           | -    | -    | HH:MM形式                          |
| 訪問内容     | content     | テキストエリア | ○    | 2000 | 複数行                             |
| 結果         | result      | セレクト       | -    | -    | 商談中/成約/見送り/情報収集/その他 |
| 添付ファイル | attachment  | ファイル       | -    | -    | 複数可、10MB以下                   |

**ボタン**

| ボタン名   | 動作                         |
| ---------- | ---------------------------- |
| ＋追加     | 訪問記録の入力欄を追加       |
| 削除       | 該当の訪問記録を削除         |
| 下書き保存 | 下書き状態で保存、一覧へ遷移 |
| 提出       | 提出状態で保存、一覧へ遷移   |
| キャンセル | 確認ダイアログ後、一覧へ遷移 |

**バリデーション**

| チェック内容           | エラーメッセージ                       |
| ---------------------- | -------------------------------------- |
| 報告日が未入力         | 報告日を入力してください               |
| 同一日の日報が既に存在 | この日付の日報は既に存在します         |
| 訪問記録が0件で提出    | 訪問記録を1件以上入力してください      |
| 顧客が未選択           | 顧客を選択してください                 |
| 訪問内容が未入力       | 訪問内容を入力してください             |
| 添付ファイルサイズ超過 | ファイルサイズは10MB以下にしてください |

---

#### SCR-012: 日報編集

**基本情報**

| 項目         | 内容                                          |
| ------------ | --------------------------------------------- |
| 画面ID       | SCR-012                                       |
| 画面名       | 日報編集                                      |
| URL          | /reports/:id/edit                             |
| アクセス権限 | 担当者（自分の日報かつ下書き/差戻し状態のみ） |

**画面レイアウト**: SCR-011（日報作成）と同様

**入力項目**: SCR-011（日報作成）と同様

**追加表示項目（差戻し時）**

| 項目名     | 説明                                         |
| ---------- | -------------------------------------------- |
| 差戻し理由 | 上長が記載した差戻しコメント（読み取り専用） |

---

#### SCR-013: 日報詳細

**基本情報**

| 項目         | 内容                                                     |
| ------------ | -------------------------------------------------------- |
| 画面ID       | SCR-013                                                  |
| 画面名       | 日報詳細                                                 |
| URL          | /reports/:id                                             |
| アクセス権限 | 全員（担当者は自分の日報のみ、上長は部下の日報も閲覧可） |

**画面レイアウト**

```
+--------------------------------------------------+
| [ヘッダー]                                        |
+--------------------------------------------------+
| [サイド] |  日報詳細                              |
| [バー]   |                                       |
|          |  +----------------------------------+ |
|          |  | 報告日: 2024/01/15               | |
|          |  | 担当者: 山田太郎                  | |
|          |  | ステータス: [提出済]              | |
|          |  | 提出日時: 2024/01/15 18:30       | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  訪問記録                              |
|          |  +----------------------------------+ |
|          |  | ■ 株式会社ABC  10:00             | |
|          |  |   新商品の提案を実施。担当者は    | |
|          |  |   興味を示しており、次回見積...   | |
|          |  |   結果: 商談中                    | |
|          |  |   添付: proposal.pdf [DL]        | |
|          |  |----------------------------------|  |
|          |  | ■ 株式会社XYZ  14:00             | |
|          |  |   定期訪問。特に問題なし。        | |
|          |  |   結果: 情報収集                  | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  課題・相談（Problem）                 |
|          |  +----------------------------------+ |
|          |  | 競合他社の価格攻勢が激しく、     | |
|          |  | 差別化ポイントの整理が必要。     | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  明日やること（Plan）                  |
|          |  +----------------------------------+ |
|          |  | ABC社への見積書作成              | |
|          |  | DEF社へのアポイント取得          | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  承認履歴                              |
|          |  +----------------------------------+ |
|          |  | 2024/01/15 19:00 課長:鈴木 承認  | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  コメント                              |
|          |  +----------------------------------+ |
|          |  | 鈴木課長 2024/01/15 19:05        | |
|          |  | ABC社の件、良い感触ですね。      | |
|          |  | 見積は明日中に確認します。        | |
|          |  +----------------------------------+ |
|          |  | コメントを入力...                 | |
|          |  |              [投稿]              | |
|          |  +----------------------------------+ |
|          |                                       |
|          |  [編集] [承認] [差戻し] [戻る]         |
+--------------------------------------------------+
| [フッター]                                        |
+--------------------------------------------------+
```

**表示項目**

| 項目名       | 説明                                   |
| ------------ | -------------------------------------- |
| 報告日       | 日報の対象日                           |
| 担当者       | 日報作成者                             |
| ステータス   | 現在の状態（バッジ表示）               |
| 提出日時     | 提出した日時                           |
| 訪問記録     | 顧客名、時刻、内容、結果、添付ファイル |
| 課題・相談   | Problem                                |
| 明日やること | Plan                                   |
| 承認履歴     | 承認・差戻しの履歴                     |
| コメント     | 上長からのコメント一覧                 |

**ボタン**

| ボタン名 | 動作                   | 表示条件                     |
| -------- | ---------------------- | ---------------------------- |
| 編集     | 日報編集画面へ遷移     | 担当者かつ下書き/差戻し状態  |
| 承認     | 承認確認ダイアログ表示 | 課長:提出済、部長:課長承認済 |
| 差戻し   | 差戻しダイアログ表示   | 課長:提出済、部長:課長承認済 |
| 戻る     | 一覧画面へ遷移         | 常時                         |
| 投稿     | コメントを投稿         | 課長・部長のみ               |

**ダイアログ**

承認確認ダイアログ:

- この日報を承認しますか？
- コメント（任意）入力欄
- キャンセル / 承認するボタン

差戻しダイアログ:

- この日報を差戻しますか？
- 差戻し理由（必須）入力欄
- キャンセル / 差戻すボタン

---

#### SCR-020: 承認待ち一覧

**基本情報**

| 項目         | 内容         |
| ------------ | ------------ |
| 画面ID       | SCR-020      |
| 画面名       | 承認待ち一覧 |
| URL          | /approvals   |
| アクセス権限 | 課長・部長   |

**一覧表示項目**

| 項目名   | 説明           |
| -------- | -------------- |
| 報告日   | 日報の対象日   |
| 担当者名 | 日報作成者     |
| 訪問件数 | 訪問記録の件数 |
| 提出日時 | 提出した日時   |
| 操作     | 詳細ボタン     |

---

#### SCR-030〜032: 顧客マスタ

**SCR-030: 顧客マスタ一覧**

| 項目         | 内容                             |
| ------------ | -------------------------------- |
| URL          | /customers                       |
| アクセス権限 | 全員（閲覧）、課長・部長（編集） |

検索条件: 顧客名（部分一致）、業種、状態（有効/無効）

**SCR-031: 顧客マスタ登録**

| 項目         | 内容           |
| ------------ | -------------- |
| URL          | /customers/new |
| アクセス権限 | 課長・部長     |

入力項目: 顧客名（必須）、住所、電話番号、業種

**SCR-032: 顧客マスタ編集**

| 項目         | 内容                |
| ------------ | ------------------- |
| URL          | /customers/:id/edit |
| アクセス権限 | 課長・部長          |

入力項目: SCR-031と同様 + 有効フラグ

---

#### SCR-040〜042: 営業担当者マスタ

**SCR-040: 営業担当者マスタ一覧**

| 項目         | 内容          |
| ------------ | ------------- |
| URL          | /salespersons |
| アクセス権限 | 課長・部長    |

検索条件: 氏名（部分一致）、役職、状態（有効/無効）

**SCR-041: 営業担当者マスタ登録**

| 項目         | 内容              |
| ------------ | ----------------- |
| URL          | /salespersons/new |
| アクセス権限 | 部長              |

入力項目: 氏名（必須）、メールアドレス（必須）、役職（必須）、直属上長、2次上長、初期パスワード（必須）

**SCR-042: 営業担当者マスタ編集**

| 項目         | 内容                   |
| ------------ | ---------------------- |
| URL          | /salespersons/:id/edit |
| アクセス権限 | 部長                   |

入力項目: SCR-041と同様（パスワードは任意）+ 有効フラグ、パスワードリセット

### 8.5 共通メッセージ

**確認メッセージ**

| コード | メッセージ                               | 使用場面     |
| ------ | ---------------------------------------- | ------------ |
| C001   | 保存してもよろしいですか？               | データ保存時 |
| C002   | 削除してもよろしいですか？               | データ削除時 |
| C003   | 入力内容が破棄されます。よろしいですか？ | キャンセル時 |
| C004   | 提出してもよろしいですか？               | 日報提出時   |
| C005   | 承認してもよろしいですか？               | 承認時       |
| C006   | 差戻ししてもよろしいですか？             | 差戻し時     |

**完了メッセージ**

| コード | メッセージ             | 使用場面         |
| ------ | ---------------------- | ---------------- |
| I001   | 保存しました           | データ保存完了   |
| I002   | 削除しました           | データ削除完了   |
| I003   | 提出しました           | 日報提出完了     |
| I004   | 承認しました           | 承認完了         |
| I005   | 差戻ししました         | 差戻し完了       |
| I006   | コメントを投稿しました | コメント投稿完了 |

**エラーメッセージ**

| コード | メッセージ                             | 使用場面       |
| ------ | -------------------------------------- | -------------- |
| E001   | 必須項目を入力してください             | 必須チェック   |
| E002   | 形式が正しくありません                 | 形式チェック   |
| E003   | 権限がありません                       | 権限エラー     |
| E004   | データが見つかりません                 | 存在チェック   |
| E005   | 既に登録されています                   | 重複チェック   |
| E006   | 処理に失敗しました。再度お試しください | システムエラー |

---

## 9. API仕様書

### 9.1 概要

| 項目       | 内容                             |
| ---------- | -------------------------------- |
| ベースURL  | `https://api.example.com/api/v1` |
| プロトコル | HTTPS                            |
| データ形式 | JSON                             |
| 文字コード | UTF-8                            |
| 認証方式   | Bearer Token (JWT)               |

**共通リクエストヘッダー**

| ヘッダー名    | 必須 | 説明                              |
| ------------- | ---- | --------------------------------- |
| Content-Type  | ○    | `application/json`                |
| Authorization | ○    | `Bearer {token}` ※ログインAPI以外 |

**共通レスポンス形式**

成功時:

```json
{
  "success": true,
  "data": { ... }
}
```

エラー時:

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ"
  }
}
```

**HTTPステータスコード**

| コード | 説明                             |
| ------ | -------------------------------- |
| 200    | 成功                             |
| 201    | 作成成功                         |
| 204    | 削除成功（レスポンスボディなし） |
| 400    | リクエスト不正                   |
| 401    | 認証エラー                       |
| 403    | 権限エラー                       |
| 404    | リソース未発見                   |
| 409    | 競合エラー（重複など）           |
| 422    | バリデーションエラー             |
| 500    | サーバーエラー                   |

### 9.2 API一覧

#### 認証API

| メソッド | エンドポイント | 説明                     |
| -------- | -------------- | ------------------------ |
| POST     | /auth/login    | ログイン                 |
| POST     | /auth/logout   | ログアウト               |
| GET      | /auth/me       | ログインユーザー情報取得 |
| POST     | /auth/refresh  | トークンリフレッシュ     |

#### 日報API

| メソッド | エンドポイント      | 説明         |
| -------- | ------------------- | ------------ |
| GET      | /reports            | 日報一覧取得 |
| POST     | /reports            | 日報作成     |
| GET      | /reports/:id        | 日報詳細取得 |
| PUT      | /reports/:id        | 日報更新     |
| DELETE   | /reports/:id        | 日報削除     |
| POST     | /reports/:id/submit | 日報提出     |

#### 訪問記録API

| メソッド | エンドポイント            | 説明             |
| -------- | ------------------------- | ---------------- |
| GET      | /reports/:reportId/visits | 訪問記録一覧取得 |
| POST     | /reports/:reportId/visits | 訪問記録作成     |
| PUT      | /visits/:id               | 訪問記録更新     |
| DELETE   | /visits/:id               | 訪問記録削除     |

#### 添付ファイルAPI

| メソッド | エンドポイント               | 説明                 |
| -------- | ---------------------------- | -------------------- |
| POST     | /visits/:visitId/attachments | ファイルアップロード |
| GET      | /attachments/:id             | ファイルダウンロード |
| DELETE   | /attachments/:id             | ファイル削除         |

#### 承認API

| メソッド | エンドポイント       | 説明             |
| -------- | -------------------- | ---------------- |
| GET      | /approvals           | 承認待ち一覧取得 |
| POST     | /reports/:id/approve | 日報承認         |
| POST     | /reports/:id/reject  | 日報差戻し       |

#### コメントAPI

| メソッド | エンドポイント              | 説明             |
| -------- | --------------------------- | ---------------- |
| GET      | /reports/:reportId/comments | コメント一覧取得 |
| POST     | /reports/:reportId/comments | コメント作成     |
| PUT      | /comments/:id               | コメント更新     |
| DELETE   | /comments/:id               | コメント削除     |

#### 顧客マスタAPI

| メソッド | エンドポイント | 説明         |
| -------- | -------------- | ------------ |
| GET      | /customers     | 顧客一覧取得 |
| POST     | /customers     | 顧客作成     |
| GET      | /customers/:id | 顧客詳細取得 |
| PUT      | /customers/:id | 顧客更新     |

#### 営業担当者マスタAPI

| メソッド | エンドポイント    | 説明               |
| -------- | ----------------- | ------------------ |
| GET      | /salespersons     | 営業担当者一覧取得 |
| POST     | /salespersons     | 営業担当者作成     |
| GET      | /salespersons/:id | 営業担当者詳細取得 |
| PUT      | /salespersons/:id | 営業担当者更新     |

#### マスタAPI

| メソッド | エンドポイント | 説明             |
| -------- | -------------- | ---------------- |
| GET      | /positions     | 役職一覧取得     |
| GET      | /industries    | 業種一覧取得     |
| GET      | /visit-results | 訪問結果一覧取得 |

### 9.3 API詳細定義

#### POST /auth/login

ログイン認証を行い、アクセストークンを取得する。

**リクエスト**

```json
{
  "email": "yamada@example.com",
  "password": "password123",
  "remember": true
}
```

**レスポンス（200 OK）**

```json
{
  "success": true,
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "token_type": "Bearer",
    "expires_in": 3600,
    "user": {
      "id": 1,
      "name": "山田太郎",
      "email": "yamada@example.com",
      "position": { "id": 1, "name": "担当", "level": 1 }
    }
  }
}
```

---

#### POST /reports

日報を新規作成する。

**リクエスト**

```json
{
  "report_date": "2024-01-15",
  "problem": "競合他社の価格攻勢が激しい",
  "plan": "ABC社への見積書作成",
  "visits": [
    {
      "customer_id": 1,
      "visit_time": "10:00",
      "content": "新商品の提案を実施",
      "result": "negotiating"
    }
  ]
}
```

**result（結果）の値**

| 値                    | 説明     |
| --------------------- | -------- |
| negotiating           | 商談中   |
| closed_won            | 成約     |
| closed_lost           | 見送り   |
| information_gathering | 情報収集 |
| other                 | その他   |

**レスポンス（201 Created）**

```json
{
  "success": true,
  "data": {
    "id": 1,
    "report_date": "2024-01-15",
    "status": "draft",
    "visits": [...],
    "created_at": "2024-01-15T17:00:00Z"
  }
}
```

---

#### GET /reports/:id

日報の詳細を取得する。

**レスポンス（200 OK）**

```json
{
  "success": true,
  "data": {
    "id": 1,
    "report_date": "2024-01-15",
    "salesperson": { "id": 1, "name": "山田太郎" },
    "status": "submitted",
    "problem": "...",
    "plan": "...",
    "visits": [
      {
        "id": 1,
        "customer": { "id": 1, "name": "株式会社ABC" },
        "visit_time": "10:00",
        "content": "...",
        "result": "negotiating",
        "attachments": [...]
      }
    ],
    "approval_history": [...],
    "comments": [...]
  }
}
```

---

#### POST /reports/:id/approve

日報を承認する。

**リクエスト**

```json
{
  "comment": "良い提案ですね"
}
```

**レスポンス（200 OK）**

```json
{
  "success": true,
  "data": {
    "id": 1,
    "status": "manager_approved",
    "manager_approved_at": "2024-01-15T19:00:00Z"
  }
}
```

---

#### POST /reports/:id/reject

日報を差戻しする。

**リクエスト**

```json
{
  "comment": "訪問内容をもう少し詳しく記載してください"
}
```

**レスポンス（200 OK）**

```json
{
  "success": true,
  "data": {
    "id": 1,
    "status": "rejected"
  }
}
```

---

#### POST /visits/:visitId/attachments

ファイルをアップロードする。

Content-Type: `multipart/form-data`

**許可されるファイル形式**: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG

**ファイルサイズ上限**: 10MB

**レスポンス（201 Created）**

```json
{
  "success": true,
  "data": {
    "id": 1,
    "file_name": "proposal.pdf",
    "file_size": 1024000,
    "content_type": "application/pdf",
    "download_url": "/api/v1/attachments/1"
  }
}
```

### 9.4 エラーコード一覧

**共通エラー**

| エラーコード     | HTTPステータス | 説明                             |
| ---------------- | -------------- | -------------------------------- |
| UNAUTHORIZED     | 401            | 認証が必要です                   |
| INVALID_TOKEN    | 401            | トークンが無効です               |
| TOKEN_EXPIRED    | 401            | トークンの有効期限が切れています |
| FORBIDDEN        | 403            | 権限がありません                 |
| NOT_FOUND        | 404            | リソースが見つかりません         |
| VALIDATION_ERROR | 422            | 入力値が不正です                 |
| INTERNAL_ERROR   | 500            | サーバーエラーが発生しました     |

**業務エラー**

| エラーコード          | HTTPステータス | 説明                                             |
| --------------------- | -------------- | ------------------------------------------------ |
| INVALID_CREDENTIALS   | 401            | メールアドレスまたはパスワードが正しくありません |
| ACCOUNT_DISABLED      | 401            | アカウントが無効です                             |
| DUPLICATE_REPORT      | 409            | この日付の日報は既に存在します                   |
| INVALID_STATUS        | 403            | この状態では操作できません                       |
| NO_VISITS             | 422            | 訪問記録を1件以上入力してください                |
| FILE_TOO_LARGE        | 413            | ファイルサイズは10MB以下にしてください           |
| UNSUPPORTED_FILE_TYPE | 415            | サポートされていないファイル形式です             |
| DUPLICATE_EMAIL       | 409            | このメールアドレスは既に登録されています         |

### 9.5 認可ルール

**役職別アクセス権限**

| API                 | 担当者                   | 課長      | 部長      |
| ------------------- | ------------------------ | --------- | --------- |
| 日報作成            | ○（自分）                | -         | -         |
| 日報編集            | ○（自分・下書き/差戻し） | -         | -         |
| 日報閲覧            | ○（自分）                | ○（部下） | ○（全員） |
| 日報提出            | ○（自分）                | -         | -         |
| 課長承認            | -                        | ○（部下） | -         |
| 部長承認            | -                        | -         | ○（全員） |
| コメント投稿        | -                        | ○         | ○         |
| 顧客作成/編集       | -                        | ○         | ○         |
| 営業担当者作成/編集 | -                        | -         | ○         |

**ステータス別操作権限**

| 操作       | draft | submitted | manager_approved | approved | rejected |
| ---------- | ----- | --------- | ---------------- | -------- | -------- |
| 編集       | ○     | -         | -                | -        | ○        |
| 削除       | ○     | -         | -                | -        | -        |
| 提出       | ○     | -         | -                | -        | ○        |
| 課長承認   | -     | ○         | -                | -        | -        |
| 課長差戻し | -     | ○         | -                | -        | -        |
| 部長承認   | -     | -         | ○                | -        | -        |
| 部長差戻し | -     | -         | ○                | -        | -        |

---

## 10. テスト仕様書

### 10.1 テスト概要

| テスト種別     | 目的                          |
| -------------- | ----------------------------- |
| 単体テスト     | 各機能の個別動作確認          |
| 画面テスト     | 各画面のUI/UX動作確認         |
| APIテスト      | 各APIエンドポイントの動作確認 |
| 結合テスト     | 機能間連携の確認              |
| シナリオテスト | 業務フロー全体の確認          |
| 異常系テスト   | エラー処理の確認              |
| 性能テスト     | 応答時間・負荷の確認          |

---

### 8.2 単体テスト

#### 8.2.1 マスタ管理

| テストID | テスト項目                   | 事前条件               | 操作                   | 期待結果               |
| -------- | ---------------------------- | ---------------------- | ---------------------- | ---------------------- |
| UT-M-001 | 顧客登録                     | ログイン済             | 必須項目を入力して登録 | 顧客が登録される       |
| UT-M-002 | 顧客登録（必須項目未入力）   | ログイン済             | 顧客名を空で登録       | エラーメッセージ表示   |
| UT-M-003 | 顧客編集                     | 顧客が存在             | 顧客情報を変更して保存 | 変更が反映される       |
| UT-M-004 | 顧客無効化                   | 顧客が存在             | 有効フラグをOFF        | 顧客が無効化される     |
| UT-M-005 | 営業担当者登録               | ログイン済             | 必須項目を入力して登録 | 営業担当者が登録される |
| UT-M-006 | 営業担当者登録（メール重複） | 同一メールの担当者存在 | 重複メールで登録       | エラーメッセージ表示   |
| UT-M-007 | 上長設定                     | 営業担当者が存在       | 課長・部長を設定       | 上長関係が設定される   |

#### 8.2.2 日報作成

| テストID | テスト項目           | 事前条件             | 操作               | 期待結果               |
| -------- | -------------------- | -------------------- | ------------------ | ---------------------- |
| UT-R-001 | 日報新規作成         | 営業担当者でログイン | 日報を新規作成     | 下書き状態で日報作成   |
| UT-R-002 | 日報編集（下書き）   | 下書き日報が存在     | 内容を編集して保存 | 変更が保存される       |
| UT-R-003 | 日報編集（提出済）   | 提出済日報が存在     | 編集を試みる       | 編集不可（エラー表示） |
| UT-R-004 | Problem入力          | 日報編集中           | 課題・相談を入力   | 入力内容が保存される   |
| UT-R-005 | Plan入力             | 日報編集中           | 明日やることを入力 | 入力内容が保存される   |
| UT-R-006 | 同一日の日報重複作成 | 当日の日報が存在     | 新規日報を作成     | エラーメッセージ表示   |

#### 8.2.3 訪問記録

| テストID | テスト項目       | 事前条件       | 操作                       | 期待結果                 |
| -------- | ---------------- | -------------- | -------------------------- | ------------------------ |
| UT-V-001 | 訪問記録追加     | 日報編集中     | 顧客を選択し訪問内容を入力 | 訪問記録が追加される     |
| UT-V-002 | 訪問記録複数追加 | 日報編集中     | 複数の訪問記録を追加       | すべての記録が追加される |
| UT-V-003 | 訪問記録編集     | 訪問記録が存在 | 訪問内容を変更             | 変更が保存される         |
| UT-V-004 | 訪問記録削除     | 訪問記録が存在 | 訪問記録を削除             | 記録が削除される         |
| UT-V-005 | 訪問時刻入力     | 訪問記録追加中 | 訪問時刻を設定             | 時刻が保存される         |
| UT-V-006 | 結果選択         | 訪問記録追加中 | 結果を選択                 | 結果が保存される         |

#### 8.2.4 添付ファイル

| テストID | テスト項目           | 事前条件           | 操作                               | 期待結果                     |
| -------- | -------------------- | ------------------ | ---------------------------------- | ---------------------------- |
| UT-A-001 | ファイル添付         | 訪問記録が存在     | ファイルをアップロード             | ファイルが添付される         |
| UT-A-002 | 複数ファイル添付     | 訪問記録が存在     | 複数ファイルをアップロード         | すべて添付される             |
| UT-A-003 | ファイルダウンロード | 添付ファイルが存在 | ダウンロードボタンクリック         | ファイルがダウンロードされる |
| UT-A-004 | ファイル削除         | 添付ファイルが存在 | 削除ボタンクリック                 | ファイルが削除される         |
| UT-A-005 | 不正ファイル形式     | 訪問記録が存在     | 許可されていない形式をアップロード | エラーメッセージ表示         |
| UT-A-006 | ファイルサイズ超過   | 訪問記録が存在     | 上限を超えるファイルをアップロード | エラーメッセージ表示         |

#### 8.2.5 承認フロー

| テストID  | テスト項目                   | 事前条件                             | 操作                 | 期待結果                         |
| --------- | ---------------------------- | ------------------------------------ | -------------------- | -------------------------------- |
| UT-AP-001 | 日報提出                     | 下書き日報が存在                     | 提出ボタンクリック   | ステータスが「提出済」に変更     |
| UT-AP-002 | 課長承認                     | 提出済日報が存在、課長でログイン     | 承認ボタンクリック   | ステータスが「課長承認済」に変更 |
| UT-AP-003 | 課長差戻し                   | 提出済日報が存在、課長でログイン     | 差戻しボタンクリック | ステータスが「差戻し」に変更     |
| UT-AP-004 | 部長承認                     | 課長承認済日報が存在、部長でログイン | 承認ボタンクリック   | ステータスが「承認完了」に変更   |
| UT-AP-005 | 部長差戻し                   | 課長承認済日報が存在、部長でログイン | 差戻しボタンクリック | ステータスが「差戻し」に変更     |
| UT-AP-006 | 承認履歴記録                 | 承認操作実行                         | 承認/差戻し          | 承認履歴が記録される             |
| UT-AP-007 | 差戻し後の再編集             | 差戻し日報が存在                     | 日報を編集           | 編集可能                         |
| UT-AP-008 | 差戻し後の再提出             | 差戻し日報を編集済                   | 再提出               | ステータスが「提出済」に変更     |
| UT-AP-009 | 権限外承認（担当者が承認）   | 提出済日報が存在、担当者でログイン   | 承認を試みる         | エラーメッセージ表示             |
| UT-AP-010 | 権限外承認（課長が部長承認） | 課長承認済日報が存在、課長でログイン | 部長承認を試みる     | エラーメッセージ表示             |

#### 8.2.6 コメント

| テストID | テスト項目             | 事前条件                         | 操作                   | 期待結果                         |
| -------- | ---------------------- | -------------------------------- | ---------------------- | -------------------------------- |
| UT-C-001 | コメント追加（課長）   | 日報が存在、課長でログイン       | コメントを入力して投稿 | コメントが追加される             |
| UT-C-002 | コメント追加（部長）   | 日報が存在、部長でログイン       | コメントを入力して投稿 | コメントが追加される             |
| UT-C-003 | コメント追加（担当者） | 日報が存在、担当者でログイン     | コメント投稿を試みる   | エラーメッセージ表示（権限なし） |
| UT-C-004 | コメント編集           | コメントが存在、投稿者でログイン | コメントを編集         | 変更が保存される                 |
| UT-C-005 | コメント削除           | コメントが存在、投稿者でログイン | コメントを削除         | コメントが削除される             |

---

### 8.3 画面テスト

#### 8.3.1 SCR-001: ログイン画面

| テストID   | テスト項目                 | 操作                           | 期待結果                                                                 |
| ---------- | -------------------------- | ------------------------------ | ------------------------------------------------------------------------ |
| UI-001-001 | 画面表示                   | /login にアクセス              | ログイン画面が表示される                                                 |
| UI-001-002 | メールアドレス入力         | メールアドレス欄に入力         | 入力値が表示される                                                       |
| UI-001-003 | パスワード入力             | パスワード欄に入力             | マスク表示される                                                         |
| UI-001-004 | ログイン成功               | 正しい認証情報でログイン       | ダッシュボードへ遷移                                                     |
| UI-001-005 | ログイン失敗               | 誤った認証情報でログイン       | エラーメッセージ「メールアドレスまたはパスワードが正しくありません」表示 |
| UI-001-006 | 必須チェック（メール）     | メールアドレス未入力でログイン | エラーメッセージ「メールアドレスを入力してください」表示                 |
| UI-001-007 | 必須チェック（パスワード） | パスワード未入力でログイン     | エラーメッセージ「パスワードを入力してください」表示                     |
| UI-001-008 | メール形式チェック         | 不正なメール形式で入力         | エラーメッセージ「形式が正しくありません」表示                           |
| UI-001-009 | ログイン状態保持           | チェックボックスONでログイン   | ブラウザ再起動後もログイン状態維持                                       |

#### 8.3.2 SCR-002: ダッシュボード

| テストID   | テスト項目         | 操作                         | 期待結果                             |
| ---------- | ------------------ | ---------------------------- | ------------------------------------ |
| UI-002-001 | 画面表示（担当者） | 担当者でログイン後アクセス   | ダッシュボード表示、承認待ちは非表示 |
| UI-002-002 | 画面表示（課長）   | 課長でログイン後アクセス     | ダッシュボード表示、承認待ち件数表示 |
| UI-002-003 | 画面表示（部長）   | 部長でログイン後アクセス     | ダッシュボード表示、承認待ち件数表示 |
| UI-002-004 | 今月の日報件数     | ダッシュボード表示           | 当月の日報作成・提出件数が正しく表示 |
| UI-002-005 | 最近の日報表示     | ダッシュボード表示           | 直近5件の日報が表示される            |
| UI-002-006 | 日報一覧へ遷移     | サイドバーの日報一覧クリック | 日報一覧画面へ遷移                   |
| UI-002-007 | ログアウト         | ログアウトボタンクリック     | ログイン画面へ遷移                   |

#### 8.3.3 SCR-010: 日報一覧

| テストID   | テスト項目                   | 操作                       | 期待結果                         |
| ---------- | ---------------------------- | -------------------------- | -------------------------------- |
| UI-010-001 | 画面表示                     | /reports にアクセス        | 日報一覧が表示される             |
| UI-010-002 | 新規作成ボタン表示（担当者） | 担当者でアクセス           | 新規作成ボタンが表示される       |
| UI-010-003 | 新規作成ボタン非表示（上長） | 課長でアクセス             | 新規作成ボタンが非表示           |
| UI-010-004 | 期間検索                     | 日付範囲を指定して検索     | 指定期間の日報のみ表示           |
| UI-010-005 | 担当者検索（上長）           | 担当者を選択して検索       | 選択した担当者の日報のみ表示     |
| UI-010-006 | ステータス検索               | ステータスを選択して検索   | 選択したステータスの日報のみ表示 |
| UI-010-007 | 検索条件クリア               | クリアボタンクリック       | 検索条件がリセットされる         |
| UI-010-008 | ソート（日付）               | 日付カラムヘッダークリック | 日付順でソートされる             |
| UI-010-009 | ページネーション             | 次へボタンクリック         | 次のページが表示される           |
| UI-010-010 | 詳細画面遷移                 | 詳細ボタンクリック         | 日報詳細画面へ遷移               |

#### 8.3.4 SCR-011: 日報作成

| テストID   | テスト項目                         | 操作                       | 期待結果                                                  |
| ---------- | ---------------------------------- | -------------------------- | --------------------------------------------------------- |
| UI-011-001 | 画面表示                           | /reports/new にアクセス    | 日報作成画面が表示される                                  |
| UI-011-002 | 報告日デフォルト                   | 画面表示時                 | 当日の日付がデフォルト設定                                |
| UI-011-003 | 訪問記録追加                       | ＋追加ボタンクリック       | 訪問記録入力欄が追加される                                |
| UI-011-004 | 訪問記録削除                       | 削除ボタンクリック         | 該当の訪問記録入力欄が削除される                          |
| UI-011-005 | 顧客選択                           | 顧客セレクトボックス操作   | 有効な顧客のみ表示、選択可能                              |
| UI-011-006 | ファイル選択                       | ファイル選択ボタンクリック | ファイル選択ダイアログ表示                                |
| UI-011-007 | 下書き保存                         | 下書き保存ボタンクリック   | 下書き状態で保存、一覧へ遷移                              |
| UI-011-008 | 提出                               | 提出ボタンクリック         | 確認ダイアログ表示後、提出状態で保存                      |
| UI-011-009 | キャンセル                         | キャンセルボタンクリック   | 確認ダイアログ後、一覧へ遷移                              |
| UI-011-010 | 必須チェック（報告日）             | 報告日未入力で保存         | エラーメッセージ表示                                      |
| UI-011-011 | 必須チェック（訪問記録なしで提出） | 訪問記録0件で提出          | エラーメッセージ「訪問記録を1件以上入力してください」表示 |
| UI-011-012 | 必須チェック（顧客未選択）         | 顧客未選択で保存           | エラーメッセージ「顧客を選択してください」表示            |
| UI-011-013 | 必須チェック（訪問内容未入力）     | 訪問内容未入力で保存       | エラーメッセージ「訪問内容を入力してください」表示        |

#### 8.3.5 SCR-012: 日報編集

| テストID   | テスト項目         | 操作                           | 期待結果                               |
| ---------- | ------------------ | ------------------------------ | -------------------------------------- |
| UI-012-001 | 画面表示（下書き） | 下書き日報の編集画面にアクセス | 編集画面が表示される                   |
| UI-012-002 | 画面表示（差戻し） | 差戻し日報の編集画面にアクセス | 編集画面が表示、差戻し理由が表示される |
| UI-012-003 | 画面表示（提出済） | 提出済日報の編集画面にアクセス | 編集不可、エラーまたはリダイレクト     |
| UI-012-004 | 既存データ表示     | 編集画面表示                   | 既存の入力内容が表示される             |
| UI-012-005 | 保存               | 変更後に保存                   | 変更内容が保存される                   |

#### 8.3.6 SCR-013: 日報詳細

| テストID   | テスト項目                         | 操作                       | 期待結果                               |
| ---------- | ---------------------------------- | -------------------------- | -------------------------------------- |
| UI-013-001 | 画面表示                           | /reports/:id にアクセス    | 日報詳細が表示される                   |
| UI-013-002 | 訪問記録表示                       | 画面表示                   | 全訪問記録が一覧表示される             |
| UI-013-003 | 添付ファイル表示                   | 画面表示                   | 添付ファイル名とダウンロードリンク表示 |
| UI-013-004 | 添付ファイルダウンロード           | ダウンロードリンククリック | ファイルがダウンロードされる           |
| UI-013-005 | 承認履歴表示                       | 画面表示                   | 承認履歴が時系列で表示される           |
| UI-013-006 | コメント表示                       | 画面表示                   | コメントが時系列で表示される           |
| UI-013-007 | 編集ボタン表示（担当者・下書き）   | 担当者で下書き日報を表示   | 編集ボタンが表示される                 |
| UI-013-008 | 編集ボタン非表示（担当者・提出済） | 担当者で提出済日報を表示   | 編集ボタンが非表示                     |
| UI-013-009 | 承認ボタン表示（課長・提出済）     | 課長で提出済日報を表示     | 承認・差戻しボタンが表示される         |
| UI-013-010 | 承認ダイアログ                     | 承認ボタンクリック         | 承認確認ダイアログ表示                 |
| UI-013-011 | 差戻しダイアログ                   | 差戻しボタンクリック       | 差戻しダイアログ表示、理由入力必須     |
| UI-013-012 | コメント投稿（上長）               | 課長でコメント入力・投稿   | コメントが追加される                   |
| UI-013-013 | コメント投稿不可（担当者）         | 担当者でコメント投稿欄確認 | コメント投稿欄が非表示                 |

#### 8.3.7 SCR-020: 承認待ち一覧

| テストID   | テスト項目             | 操作                           | 期待結果                    |
| ---------- | ---------------------- | ------------------------------ | --------------------------- |
| UI-020-001 | 画面表示（課長）       | 課長で /approvals にアクセス   | 課長承認待ちの日報一覧表示  |
| UI-020-002 | 画面表示（部長）       | 部長で /approvals にアクセス   | 部長承認待ちの日報一覧表示  |
| UI-020-003 | アクセス制限（担当者） | 担当者で /approvals にアクセス | 403エラーまたはリダイレクト |
| UI-020-004 | 詳細画面遷移           | 詳細ボタンクリック             | 日報詳細画面へ遷移          |

#### 8.3.8 SCR-030〜032: 顧客マスタ

| テストID   | テスト項目                       | 操作                           | 期待結果                         |
| ---------- | -------------------------------- | ------------------------------ | -------------------------------- |
| UI-030-001 | 一覧画面表示                     | /customers にアクセス          | 顧客一覧が表示される             |
| UI-030-002 | 顧客名検索                       | 顧客名を入力して検索           | 部分一致する顧客のみ表示         |
| UI-030-003 | 業種検索                         | 業種を選択して検索             | 選択した業種の顧客のみ表示       |
| UI-030-004 | 新規登録ボタン表示（課長・部長） | 課長でアクセス                 | 新規登録ボタン表示               |
| UI-030-005 | 新規登録ボタン非表示（担当者）   | 担当者でアクセス               | 新規登録ボタン非表示             |
| UI-031-001 | 登録画面表示                     | /customers/new にアクセス      | 顧客登録画面表示                 |
| UI-031-002 | 必須チェック                     | 顧客名未入力で登録             | エラーメッセージ表示             |
| UI-031-003 | 登録成功                         | 必須項目入力して登録           | 顧客が登録され一覧へ遷移         |
| UI-032-001 | 編集画面表示                     | /customers/:id/edit にアクセス | 顧客編集画面表示、既存データ表示 |
| UI-032-002 | 有効フラグ変更                   | 有効フラグをOFFに変更          | 顧客が無効化される               |

#### 8.3.9 SCR-040〜042: 営業担当者マスタ

| テストID   | テスト項目                   | 操作                               | 期待結果                                                         |
| ---------- | ---------------------------- | ---------------------------------- | ---------------------------------------------------------------- |
| UI-040-001 | 一覧画面表示                 | /salespersons にアクセス           | 営業担当者一覧が表示される                                       |
| UI-040-002 | アクセス制限（担当者）       | 担当者でアクセス                   | 403エラーまたはリダイレクト                                      |
| UI-040-003 | 氏名検索                     | 氏名を入力して検索                 | 部分一致する担当者のみ表示                                       |
| UI-040-004 | 新規登録ボタン表示（部長）   | 部長でアクセス                     | 新規登録ボタン表示                                               |
| UI-040-005 | 新規登録ボタン非表示（課長） | 課長でアクセス                     | 新規登録ボタン非表示                                             |
| UI-041-001 | 登録画面表示                 | /salespersons/new にアクセス       | 営業担当者登録画面表示                                           |
| UI-041-002 | 必須チェック                 | 必須項目未入力で登録               | エラーメッセージ表示                                             |
| UI-041-003 | メール重複チェック           | 既存メールで登録                   | エラーメッセージ「このメールアドレスは既に登録されています」表示 |
| UI-041-004 | 登録成功                     | 必須項目入力して登録               | 営業担当者が登録され一覧へ遷移                                   |
| UI-042-001 | 編集画面表示                 | /salespersons/:id/edit にアクセス  | 営業担当者編集画面表示                                           |
| UI-042-002 | パスワードリセット           | パスワードリセットチェックONで保存 | パスワードがリセットされる                                       |

---

### 8.4 APIテスト

#### 8.4.1 認証API

| テストID     | エンドポイント | メソッド | テスト内容               | 期待結果                   |
| ------------ | -------------- | -------- | ------------------------ | -------------------------- |
| API-AUTH-001 | /auth/login    | POST     | 正常ログイン             | 200 OK、access_token返却   |
| API-AUTH-002 | /auth/login    | POST     | 誤ったパスワード         | 401、INVALID_CREDENTIALS   |
| API-AUTH-003 | /auth/login    | POST     | 存在しないメール         | 401、INVALID_CREDENTIALS   |
| API-AUTH-004 | /auth/login    | POST     | 無効アカウント           | 401、ACCOUNT_DISABLED      |
| API-AUTH-005 | /auth/login    | POST     | メール未入力             | 422、VALIDATION_ERROR      |
| API-AUTH-006 | /auth/login    | POST     | パスワード未入力         | 422、VALIDATION_ERROR      |
| API-AUTH-007 | /auth/logout   | POST     | 正常ログアウト           | 200 OK                     |
| API-AUTH-008 | /auth/logout   | POST     | トークンなし             | 401、UNAUTHORIZED          |
| API-AUTH-009 | /auth/me       | GET      | ユーザー情報取得         | 200 OK、ユーザー情報返却   |
| API-AUTH-010 | /auth/me       | GET      | 無効トークン             | 401、INVALID_TOKEN         |
| API-AUTH-011 | /auth/refresh  | POST     | トークンリフレッシュ     | 200 OK、新access_token返却 |
| API-AUTH-012 | /auth/refresh  | POST     | 無効リフレッシュトークン | 401、INVALID_TOKEN         |

#### 8.4.2 日報API

| テストID    | エンドポイント      | メソッド | テスト内容         | 期待結果                             |
| ----------- | ------------------- | -------- | ------------------ | ------------------------------------ |
| API-RPT-001 | /reports            | GET      | 日報一覧取得       | 200 OK、日報一覧返却                 |
| API-RPT-002 | /reports            | GET      | 期間フィルタ       | 200 OK、該当期間の日報のみ返却       |
| API-RPT-003 | /reports            | GET      | ステータスフィルタ | 200 OK、該当ステータスの日報のみ返却 |
| API-RPT-004 | /reports            | GET      | ページネーション   | 200 OK、指定ページの日報返却         |
| API-RPT-005 | /reports            | POST     | 日報作成           | 201 Created、日報データ返却          |
| API-RPT-006 | /reports            | POST     | 重複日付           | 409、DUPLICATE_REPORT                |
| API-RPT-007 | /reports            | POST     | 必須項目未入力     | 422、VALIDATION_ERROR                |
| API-RPT-008 | /reports/:id        | GET      | 日報詳細取得       | 200 OK、日報詳細返却                 |
| API-RPT-009 | /reports/:id        | GET      | 存在しないID       | 404、NOT_FOUND                       |
| API-RPT-010 | /reports/:id        | GET      | 権限外アクセス     | 403、FORBIDDEN                       |
| API-RPT-011 | /reports/:id        | PUT      | 日報更新（下書き） | 200 OK、更新後データ返却             |
| API-RPT-012 | /reports/:id        | PUT      | 日報更新（提出済） | 403、INVALID_STATUS                  |
| API-RPT-013 | /reports/:id        | DELETE   | 日報削除（下書き） | 204 No Content                       |
| API-RPT-014 | /reports/:id        | DELETE   | 日報削除（提出済） | 403、INVALID_STATUS                  |
| API-RPT-015 | /reports/:id/submit | POST     | 日報提出           | 200 OK、status=submitted             |
| API-RPT-016 | /reports/:id/submit | POST     | 訪問記録なしで提出 | 422、NO_VISITS                       |

#### 8.4.3 訪問記録API

| テストID    | エンドポイント      | メソッド | テスト内容       | 期待結果                  |
| ----------- | ------------------- | -------- | ---------------- | ------------------------- |
| API-VST-001 | /reports/:id/visits | GET      | 訪問記録一覧取得 | 200 OK、訪問記録一覧返却  |
| API-VST-002 | /reports/:id/visits | POST     | 訪問記録追加     | 201 Created、訪問記録返却 |
| API-VST-003 | /reports/:id/visits | POST     | 顧客未指定       | 422、VALIDATION_ERROR     |
| API-VST-004 | /reports/:id/visits | POST     | 訪問内容未入力   | 422、VALIDATION_ERROR     |
| API-VST-005 | /visits/:id         | PUT      | 訪問記録更新     | 200 OK、更新後データ返却  |
| API-VST-006 | /visits/:id         | DELETE   | 訪問記録削除     | 204 No Content            |

#### 8.4.4 添付ファイルAPI

| テストID    | エンドポイント          | メソッド | テスト内容                   | 期待結果                      |
| ----------- | ----------------------- | -------- | ---------------------------- | ----------------------------- |
| API-ATT-001 | /visits/:id/attachments | POST     | ファイルアップロード（PDF）  | 201 Created、ファイル情報返却 |
| API-ATT-002 | /visits/:id/attachments | POST     | ファイルアップロード（画像） | 201 Created、ファイル情報返却 |
| API-ATT-003 | /visits/:id/attachments | POST     | 不正ファイル形式             | 415、UNSUPPORTED_FILE_TYPE    |
| API-ATT-004 | /visits/:id/attachments | POST     | ファイルサイズ超過           | 413、FILE_TOO_LARGE           |
| API-ATT-005 | /attachments/:id        | GET      | ファイルダウンロード         | 200 OK、ファイルバイナリ返却  |
| API-ATT-006 | /attachments/:id        | GET      | 存在しないファイル           | 404、NOT_FOUND                |
| API-ATT-007 | /attachments/:id        | DELETE   | ファイル削除                 | 204 No Content                |

#### 8.4.5 承認API

| テストID    | エンドポイント       | メソッド | テスト内容               | 期待結果                        |
| ----------- | -------------------- | -------- | ------------------------ | ------------------------------- |
| API-APR-001 | /approvals           | GET      | 承認待ち一覧取得（課長） | 200 OK、提出済日報一覧返却      |
| API-APR-002 | /approvals           | GET      | 承認待ち一覧取得（部長） | 200 OK、課長承認済日報一覧返却  |
| API-APR-003 | /approvals           | GET      | 権限外アクセス（担当者） | 403、FORBIDDEN                  |
| API-APR-004 | /reports/:id/approve | POST     | 課長承認                 | 200 OK、status=manager_approved |
| API-APR-005 | /reports/:id/approve | POST     | 部長承認                 | 200 OK、status=approved         |
| API-APR-006 | /reports/:id/approve | POST     | 権限外承認               | 403、FORBIDDEN                  |
| API-APR-007 | /reports/:id/approve | POST     | 不正ステータスで承認     | 403、INVALID_STATUS             |
| API-APR-008 | /reports/:id/reject  | POST     | 課長差戻し               | 200 OK、status=rejected         |
| API-APR-009 | /reports/:id/reject  | POST     | 差戻し理由未入力         | 422、VALIDATION_ERROR           |

#### 8.4.6 コメントAPI

| テストID    | エンドポイント        | メソッド | テスト内容             | 期待結果                  |
| ----------- | --------------------- | -------- | ---------------------- | ------------------------- |
| API-CMT-001 | /reports/:id/comments | GET      | コメント一覧取得       | 200 OK、コメント一覧返却  |
| API-CMT-002 | /reports/:id/comments | POST     | コメント投稿（課長）   | 201 Created、コメント返却 |
| API-CMT-003 | /reports/:id/comments | POST     | コメント投稿（担当者） | 403、FORBIDDEN            |
| API-CMT-004 | /reports/:id/comments | POST     | 内容未入力             | 422、VALIDATION_ERROR     |
| API-CMT-005 | /comments/:id         | PUT      | コメント更新（投稿者） | 200 OK、更新後データ返却  |
| API-CMT-006 | /comments/:id         | PUT      | コメント更新（他者）   | 403、FORBIDDEN            |
| API-CMT-007 | /comments/:id         | DELETE   | コメント削除           | 204 No Content            |

#### 8.4.7 顧客マスタAPI

| テストID    | エンドポイント | メソッド | テスト内容         | 期待結果                    |
| ----------- | -------------- | -------- | ------------------ | --------------------------- |
| API-CST-001 | /customers     | GET      | 顧客一覧取得       | 200 OK、顧客一覧返却        |
| API-CST-002 | /customers     | GET      | 名前検索           | 200 OK、該当顧客のみ返却    |
| API-CST-003 | /customers     | POST     | 顧客作成（課長）   | 201 Created、顧客データ返却 |
| API-CST-004 | /customers     | POST     | 顧客作成（担当者） | 403、FORBIDDEN              |
| API-CST-005 | /customers     | POST     | 顧客名未入力       | 422、VALIDATION_ERROR       |
| API-CST-006 | /customers/:id | GET      | 顧客詳細取得       | 200 OK、顧客詳細返却        |
| API-CST-007 | /customers/:id | PUT      | 顧客更新           | 200 OK、更新後データ返却    |

#### 8.4.8 営業担当者マスタAPI

| テストID    | エンドポイント    | メソッド | テスト内容               | 期待結果                 |
| ----------- | ----------------- | -------- | ------------------------ | ------------------------ |
| API-SLP-001 | /salespersons     | GET      | 営業担当者一覧取得       | 200 OK、一覧返却         |
| API-SLP-002 | /salespersons     | GET      | 権限外アクセス（担当者） | 403、FORBIDDEN           |
| API-SLP-003 | /salespersons     | POST     | 営業担当者作成（部長）   | 201 Created、データ返却  |
| API-SLP-004 | /salespersons     | POST     | 営業担当者作成（課長）   | 403、FORBIDDEN           |
| API-SLP-005 | /salespersons     | POST     | メール重複               | 409、DUPLICATE_EMAIL     |
| API-SLP-006 | /salespersons/:id | GET      | 営業担当者詳細取得       | 200 OK、詳細返却         |
| API-SLP-007 | /salespersons/:id | PUT      | 営業担当者更新           | 200 OK、更新後データ返却 |

#### 8.4.9 マスタAPI

| テストID    | エンドポイント | メソッド | テスト内容       | 期待結果                 |
| ----------- | -------------- | -------- | ---------------- | ------------------------ |
| API-MST-001 | /positions     | GET      | 役職一覧取得     | 200 OK、役職一覧返却     |
| API-MST-002 | /industries    | GET      | 業種一覧取得     | 200 OK、業種一覧返却     |
| API-MST-003 | /visit-results | GET      | 訪問結果一覧取得 | 200 OK、訪問結果一覧返却 |

---

### 8.5 結合テスト

#### 8.5.1 機能間連携

| テストID | テスト項目                       | 事前条件                       | 操作                       | 期待結果                           |
| -------- | -------------------------------- | ------------------------------ | -------------------------- | ---------------------------------- |
| IT-001   | 日報と訪問記録の連携             | 日報が存在                     | 訪問記録を追加して日報保存 | 日報と訪問記録が紐づいて保存される |
| IT-002   | 訪問記録と添付ファイルの連携     | 訪問記録が存在                 | ファイルを添付             | 訪問記録とファイルが紐づく         |
| IT-003   | 日報削除時の訪問記録削除         | 訪問記録付き日報が存在         | 日報を削除                 | 関連する訪問記録も削除される       |
| IT-004   | 訪問記録削除時の添付ファイル削除 | 添付ファイル付き訪問記録が存在 | 訪問記録を削除             | 関連する添付ファイルも削除される   |
| IT-005   | 承認と履歴の連携                 | 提出済日報が存在               | 課長が承認                 | 承認履歴が正しく記録される         |
| IT-006   | 顧客無効化と訪問記録             | 訪問記録で使用中の顧客が存在   | 顧客を無効化               | 既存の訪問記録は保持、新規選択不可 |
| IT-007   | 営業担当者無効化と日報           | 日報を持つ担当者が存在         | 担当者を無効化             | 既存の日報は保持、新規作成不可     |

#### 8.5.2 画面とAPI連携

| テストID      | テスト項目               | 操作                       | 期待結果                                              |
| ------------- | ------------------------ | -------------------------- | ----------------------------------------------------- |
| IT-UI-API-001 | ログイン画面→認証API     | ログイン画面で認証情報入力 | POST /auth/login が呼ばれ、成功時ダッシュボードへ遷移 |
| IT-UI-API-002 | 日報作成画面→日報API     | 日報作成画面で保存         | POST /reports が呼ばれ、日報が作成される              |
| IT-UI-API-003 | 日報詳細画面→承認API     | 承認ボタンクリック         | POST /reports/:id/approve が呼ばれ、ステータス更新    |
| IT-UI-API-004 | 添付ファイル→ファイルAPI | ファイルアップロード       | POST /visits/:id/attachments が呼ばれ、ファイル保存   |
| IT-UI-API-005 | 顧客マスタ画面→顧客API   | 顧客登録                   | POST /customers が呼ばれ、顧客が作成される            |

---

### 8.6 シナリオテスト

#### シナリオ1: 通常の日報提出〜承認完了

| ステップ | 操作者     | 画面    | API                          | 操作                   | 期待結果                 |
| -------- | ---------- | ------- | ---------------------------- | ---------------------- | ------------------------ |
| 1        | 営業担当者 | SCR-001 | POST /auth/login             | ログイン               | ダッシュボード表示       |
| 2        | 営業担当者 | SCR-011 | POST /reports                | 日報新規作成           | 下書き日報作成           |
| 3        | 営業担当者 | SCR-011 | POST /reports/:id/visits     | 訪問記録を3件追加      | 訪問記録が追加される     |
| 4        | 営業担当者 | SCR-011 | POST /visits/:id/attachments | ファイル添付           | ファイルが添付される     |
| 5        | 営業担当者 | SCR-011 | PUT /reports/:id             | Problem/Plan入力・保存 | 内容が保存される         |
| 6        | 営業担当者 | SCR-011 | POST /reports/:id/submit     | 日報を提出             | ステータス「提出済」     |
| 7        | 課長       | SCR-001 | POST /auth/login             | ログイン               | 承認待ち日報一覧表示     |
| 8        | 課長       | SCR-013 | POST /reports/:id/comments   | コメント追加           | コメントが追加される     |
| 9        | 課長       | SCR-013 | POST /reports/:id/approve    | 日報を承認             | ステータス「課長承認済」 |
| 10       | 部長       | SCR-001 | POST /auth/login             | ログイン               | 承認待ち日報一覧表示     |
| 11       | 部長       | SCR-013 | GET /reports/:id             | 日報を確認             | 日報詳細表示             |
| 12       | 部長       | SCR-013 | POST /reports/:id/approve    | 日報を承認             | ステータス「承認完了」   |
| 13       | 営業担当者 | SCR-010 | GET /reports                 | 日報一覧を確認         | 承認完了が確認できる     |

#### シナリオ2: 差戻し〜再提出〜承認

| ステップ | 操作者     | 画面    | API                                     | 操作             | 期待結果                       |
| -------- | ---------- | ------- | --------------------------------------- | ---------------- | ------------------------------ |
| 1        | 営業担当者 | SCR-011 | POST /reports, POST /reports/:id/submit | 日報を作成・提出 | ステータス「提出済」           |
| 2        | 課長       | SCR-013 | GET /reports/:id                        | 日報を確認       | 内容に不備を発見               |
| 3        | 課長       | SCR-013 | POST /reports/:id/reject                | 差戻し           | ステータス「差戻し」、履歴記録 |
| 4        | 営業担当者 | SCR-013 | GET /reports/:id                        | 差戻し通知を確認 | 差戻し理由が確認できる         |
| 5        | 営業担当者 | SCR-012 | PUT /reports/:id                        | 日報を修正       | 内容が更新される               |
| 6        | 営業担当者 | SCR-012 | POST /reports/:id/submit                | 日報を再提出     | ステータス「提出済」           |
| 7        | 課長       | SCR-013 | POST /reports/:id/approve               | 日報を承認       | ステータス「課長承認済」       |
| 8        | 部長       | SCR-013 | POST /reports/:id/approve               | 日報を承認       | ステータス「承認完了」         |

#### シナリオ3: 部長による差戻し

| ステップ | 操作者     | 画面    | API                                        | 操作               | 期待結果                 |
| -------- | ---------- | ------- | ------------------------------------------ | ------------------ | ------------------------ |
| 1        | 営業担当者 | SCR-011 | POST /reports, POST /reports/:id/submit    | 日報を作成・提出   | ステータス「提出済」     |
| 2        | 課長       | SCR-013 | POST /reports/:id/approve                  | 日報を承認         | ステータス「課長承認済」 |
| 3        | 部長       | SCR-013 | POST /reports/:id/reject                   | 日報を差戻し       | ステータス「差戻し」     |
| 4        | 営業担当者 | SCR-012 | PUT /reports/:id, POST /reports/:id/submit | 日報を修正・再提出 | ステータス「提出済」     |
| 5        | 課長       | SCR-013 | POST /reports/:id/approve                  | 日報を再承認       | ステータス「課長承認済」 |
| 6        | 部長       | SCR-013 | POST /reports/:id/approve                  | 日報を承認         | ステータス「承認完了」   |

#### シナリオ4: マスタ管理フロー

| ステップ | 操作者     | 画面    | API                | 操作                     | 期待結果                     |
| -------- | ---------- | ------- | ------------------ | ------------------------ | ---------------------------- |
| 1        | 部長       | SCR-041 | POST /salespersons | 営業担当者登録           | 営業担当者が登録される       |
| 2        | 課長       | SCR-031 | POST /customers    | 顧客登録                 | 顧客が登録される             |
| 3        | 営業担当者 | SCR-011 | POST /reports      | 登録された顧客で日報作成 | 顧客が選択可能、日報作成成功 |
| 4        | 課長       | SCR-032 | PUT /customers/:id | 顧客を無効化             | 顧客が無効化される           |
| 5        | 営業担当者 | SCR-011 | -                  | 新規日報で顧客選択確認   | 無効化された顧客は選択不可   |

---

### 8.7 異常系テスト

#### 8.7.1 画面異常系

| テストID  | 画面    | テスト項目             | 操作                              | 期待結果                         |
| --------- | ------- | ---------------------- | --------------------------------- | -------------------------------- |
| EX-UI-001 | 全画面  | セッションタイムアウト | 長時間放置後に操作                | ログイン画面にリダイレクト       |
| EX-UI-002 | SCR-012 | 同時編集               | 同一日報を2人が同時編集           | 後から保存した方にエラー表示     |
| EX-UI-003 | SCR-013 | 削除済データ表示       | 削除された日報のURLに直接アクセス | 404エラーページ表示              |
| EX-UI-004 | SCR-013 | 権限外アクセス         | 他人の日報を直接URLでアクセス     | 403エラーページ表示              |
| EX-UI-005 | SCR-011 | ネットワークエラー     | 保存中にネットワーク切断          | エラーメッセージ表示、再試行可能 |
| EX-UI-006 | SCR-011 | ブラウザ戻るボタン     | 入力中にブラウザ戻る              | 確認ダイアログ表示               |

#### 8.7.2 API異常系

| テストID   | エンドポイント | テスト項目         | リクエスト                | 期待結果           |
| ---------- | -------------- | ------------------ | ------------------------- | ------------------ |
| EX-API-001 | 全API          | トークンなし       | Authorizationヘッダーなし | 401、UNAUTHORIZED  |
| EX-API-002 | 全API          | 無効トークン       | 不正なトークン            | 401、INVALID_TOKEN |
| EX-API-003 | 全API          | 期限切れトークン   | 期限切れトークン          | 401、TOKEN_EXPIRED |
| EX-API-004 | /reports/:id   | 不正なID形式       | /reports/abc              | 400、Bad Request   |
| EX-API-005 | /reports/:id   | 存在しないID       | /reports/999999           | 404、NOT_FOUND     |
| EX-API-006 | POST系         | 不正なJSON         | 不正なJSON形式            | 400、Bad Request   |
| EX-API-007 | POST系         | Content-Type未指定 | Content-Typeなし          | 400、Bad Request   |

#### 8.7.3 セキュリティテスト

| テストID   | テスト項目          | 操作                         | 期待結果                           |
| ---------- | ------------------- | ---------------------------- | ---------------------------------- |
| EX-SEC-001 | SQLインジェクション | 入力欄にSQL文を入力          | エスケープされて保存、実行されない |
| EX-SEC-002 | XSS攻撃             | 入力欄にスクリプトタグを入力 | 無害化されて表示                   |
| EX-SEC-003 | CSRF攻撃            | 外部サイトからPOSTリクエスト | CSRFトークン検証でエラー           |
| EX-SEC-004 | パストラバーサル    | ファイルパスに../を含む      | パス正規化でエラー                 |
| EX-SEC-005 | 権限昇格            | 担当者が部長用APIを直接呼出  | 403、FORBIDDEN                     |

---

### 8.8 性能テスト

#### 8.8.1 画面性能

| テストID  | 画面    | 条件                      | 期待結果          |
| --------- | ------- | ------------------------- | ----------------- |
| PT-UI-001 | SCR-010 | 1000件の日報が存在        | 3秒以内に一覧表示 |
| PT-UI-002 | SCR-010 | 検索実行                  | 2秒以内に結果表示 |
| PT-UI-003 | SCR-011 | 訪問記録10件追加          | 操作に遅延なし    |
| PT-UI-004 | SCR-013 | 添付ファイル5件の日報表示 | 3秒以内に表示     |
| PT-UI-005 | SCR-002 | ダッシュボード初期表示    | 2秒以内に表示     |

#### 8.8.2 API性能

| テストID   | エンドポイント               | 条件                       | 期待結果             |
| ---------- | ---------------------------- | -------------------------- | -------------------- |
| PT-API-001 | GET /reports                 | 1000件の日報               | 1秒以内にレスポンス  |
| PT-API-002 | POST /reports                | 訪問記録10件含む           | 2秒以内にレスポンス  |
| PT-API-003 | POST /visits/:id/attachments | 10MBファイル               | 10秒以内にレスポンス |
| PT-API-004 | GET /reports/:id             | 訪問記録・添付ファイル多数 | 1秒以内にレスポンス  |
| PT-API-005 | GET /customers               | 1000件の顧客               | 1秒以内にレスポンス  |

#### 8.8.3 負荷テスト

| テストID    | テスト項目               | 条件                       | 期待結果                           |
| ----------- | ------------------------ | -------------------------- | ---------------------------------- |
| PT-LOAD-001 | 同時ログイン             | 50ユーザー同時ログイン     | 全ユーザー5秒以内にログイン完了    |
| PT-LOAD-002 | 同時日報作成             | 20ユーザー同時日報作成     | 全ユーザー正常に作成完了           |
| PT-LOAD-003 | 同時ファイルアップロード | 10ユーザー同時アップロード | 全ファイル正常にアップロード完了   |
| PT-LOAD-004 | 継続負荷                 | 30分間継続アクセス         | 応答時間劣化なし、エラー率0.1%未満 |

---

## 11. Prismaスキーマ定義

### 11.1 概要

データベースアクセスにはPrisma ORMを使用する。スキーマファイルは `prisma/schema.prisma` に配置。

### 11.2 モデル構成

```
Models (8)
├── Position        - 役職マスタ
├── Salesperson     - 営業担当者（自己参照リレーション）
├── Customer        - 顧客マスタ
├── DailyReport     - 日報
├── VisitRecord     - 訪問記録
├── Attachment      - 添付ファイル
├── ApprovalHistory - 承認履歴
└── Comment         - コメント

Enums (4)
├── ReportStatus    - 日報ステータス
├── VisitResult     - 訪問結果
├── ApprovalAction  - 承認アクション
└── ApprovalLevel   - 承認レベル
```

### 11.3 Enum定義

#### ReportStatus（日報ステータス）

| 値               | DB値             | 説明                       |
| ---------------- | ---------------- | -------------------------- |
| draft            | draft            | 下書き                     |
| submitted        | submitted        | 提出済（課長承認待ち）     |
| manager_approved | manager_approved | 課長承認済（部長承認待ち） |
| approved         | approved         | 承認完了                   |
| rejected         | rejected         | 差戻し                     |

#### VisitResult（訪問結果）

| 値                    | DB値                  | 説明     |
| --------------------- | --------------------- | -------- |
| negotiating           | negotiating           | 商談中   |
| closed_won            | closed_won            | 成約     |
| closed_lost           | closed_lost           | 見送り   |
| information_gathering | information_gathering | 情報収集 |
| other                 | other                 | その他   |

#### ApprovalAction（承認アクション）

| 値       | DB値     | 説明   |
| -------- | -------- | ------ |
| approved | approved | 承認   |
| rejected | rejected | 差戻し |

#### ApprovalLevel（承認レベル）

| 値       | DB値     | 説明 |
| -------- | -------- | ---- |
| manager  | manager  | 課長 |
| director | director | 部長 |

### 11.4 スキーマ定義

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// Enums
// ========================================

enum ReportStatus {
  draft            @map("draft")
  submitted        @map("submitted")
  manager_approved @map("manager_approved")
  approved         @map("approved")
  rejected         @map("rejected")
}

enum VisitResult {
  negotiating           @map("negotiating")
  closed_won            @map("closed_won")
  closed_lost           @map("closed_lost")
  information_gathering @map("information_gathering")
  other                 @map("other")
}

enum ApprovalAction {
  approved @map("approved")
  rejected @map("rejected")
}

enum ApprovalLevel {
  manager  @map("manager")
  director @map("director")
}

// ========================================
// Models
// ========================================

/// 役職マスタ
model Position {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(50)
  level     Int
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  salespersons Salesperson[]

  @@map("positions")
}

/// 営業担当者マスタ
model Salesperson {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(100)
  email      String   @unique @db.VarChar(255)
  password   String   @db.VarChar(255)
  positionId Int      @map("position_id")
  managerId  Int?     @map("manager_id")
  directorId Int?     @map("director_id")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt      @map("updated_at")

  position          Position          @relation(fields: [positionId], references: [id])
  manager           Salesperson?      @relation("ManagerSubordinates", fields: [managerId], references: [id])
  director          Salesperson?      @relation("DirectorSubordinates", fields: [directorId], references: [id])
  subordinates      Salesperson[]     @relation("ManagerSubordinates")
  teamMembers       Salesperson[]     @relation("DirectorSubordinates")
  dailyReports      DailyReport[]
  comments          Comment[]
  approvalHistories ApprovalHistory[]

  @@index([positionId])
  @@index([managerId])
  @@index([directorId])
  @@map("salespersons")
}

/// 顧客マスタ
model Customer {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(200)
  address   String?  @db.VarChar(500)
  phone     String?  @db.VarChar(20)
  industry  String?  @db.VarChar(100)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  visitRecords VisitRecord[]

  @@map("customers")
}

/// 日報
model DailyReport {
  id                 Int           @id @default(autoincrement())
  salespersonId      Int           @map("salesperson_id")
  reportDate         DateTime      @map("report_date") @db.Date
  problem            String?       @db.Text
  plan               String?       @db.Text
  status             ReportStatus  @default(draft)
  submittedAt        DateTime?     @map("submitted_at")
  managerApprovedAt  DateTime?     @map("manager_approved_at")
  directorApprovedAt DateTime?     @map("director_approved_at")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt      @map("updated_at")

  salesperson       Salesperson       @relation(fields: [salespersonId], references: [id])
  visitRecords      VisitRecord[]
  comments          Comment[]
  approvalHistories ApprovalHistory[]

  @@unique([salespersonId, reportDate])
  @@index([salespersonId])
  @@index([reportDate])
  @@index([status])
  @@map("daily_reports")
}

/// 訪問記録
model VisitRecord {
  id            Int          @id @default(autoincrement())
  dailyReportId Int          @map("daily_report_id")
  customerId    Int          @map("customer_id")
  visitTime     DateTime?    @map("visit_time") @db.Time
  content       String       @db.Text
  result        VisitResult?
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt      @map("updated_at")

  dailyReport DailyReport  @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  customer    Customer     @relation(fields: [customerId], references: [id])
  attachments Attachment[]

  @@index([dailyReportId])
  @@index([customerId])
  @@map("visit_records")
}

/// 添付ファイル
model Attachment {
  id            Int      @id @default(autoincrement())
  visitRecordId Int      @map("visit_record_id")
  fileName      String   @map("file_name") @db.VarChar(255)
  filePath      String   @map("file_path") @db.VarChar(500)
  contentType   String   @map("content_type") @db.VarChar(100)
  fileSize      Int      @map("file_size")
  createdAt     DateTime @default(now()) @map("created_at")

  visitRecord VisitRecord @relation(fields: [visitRecordId], references: [id], onDelete: Cascade)

  @@index([visitRecordId])
  @@map("attachments")
}

/// 承認履歴
model ApprovalHistory {
  id            Int            @id @default(autoincrement())
  dailyReportId Int            @map("daily_report_id")
  approverId    Int            @map("approver_id")
  action        ApprovalAction
  comment       String?        @db.Text
  approvalLevel ApprovalLevel  @map("approval_level")
  createdAt     DateTime       @default(now()) @map("created_at")

  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  approver    Salesperson @relation(fields: [approverId], references: [id])

  @@index([dailyReportId])
  @@index([approverId])
  @@map("approval_histories")
}

/// コメント
model Comment {
  id            Int      @id @default(autoincrement())
  dailyReportId Int      @map("daily_report_id")
  commenterId   Int      @map("commenter_id")
  content       String   @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")

  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  commenter   Salesperson @relation(fields: [commenterId], references: [id])

  @@index([dailyReportId])
  @@index([commenterId])
  @@map("comments")
}
```

### 11.5 リレーション図

```
Position
    │
    └──< Salesperson >──┬──< DailyReport >──┬──< VisitRecord >──< Attachment
                        │                   │
                        │                   ├──< Comment
                        │                   │
                        │                   └──< ApprovalHistory
                        │
                        ├── manager (self-relation)
                        └── director (self-relation)

Customer >──< VisitRecord
```

### 11.6 使用方法

#### 環境設定

```bash
# 環境変数ファイルの作成
cp .env.example .env

# .envファイルを編集してDATABASE_URLを設定
# 例: DATABASE_URL="postgresql://postgres:password@localhost:5432/daily_report_db"
```

#### Prismaコマンド

```bash
# 依存関係インストール
npm install

# Prisma Clientの生成
npm run db:generate

# マイグレーションの作成と実行（開発環境）
npm run db:migrate

# スキーマをDBに直接反映（プロトタイプ用）
npm run db:push

# 初期データの投入
npm run db:seed

# Prisma Studioでデータ確認
npm run db:studio
```

#### 初期データ

`prisma/seed.ts` で以下の初期データが投入される：

**役職マスタ**
| id | name | level |
|----|------|-------|
| 1 | 担当 | 1 |
| 2 | 課長 | 2 |
| 3 | 部長 | 3 |

**サンプル営業担当者**
| name | email | position | manager | director |
|------|-------|----------|---------|----------|
| 田中 部長 | director@example.com | 部長 | - | - |
| 鈴木 課長 | manager@example.com | 課長 | - | 田中 部長 |
| 山田 太郎 | yamada@example.com | 担当 | 鈴木 課長 | 田中 部長 |
| 佐藤 花子 | sato@example.com | 担当 | 鈴木 課長 | 田中 部長 |

**サンプル顧客**
| name | industry |
|------|----------|
| 株式会社ABC | 製造業 |
| 株式会社XYZ | IT・通信 |
| DEF株式会社 | 小売・流通 |
| GHI商事 | 金融・保険 |

---

## 12. データスキーマ定義

Prismaモデルに対応するTypeScript型定義。フロントエンド・バックエンドで共通利用する。

ファイル: `src/schemas/data.ts`

### 12.1 Enum定義

```typescript
/** 日報ステータス */
export const ReportStatus = {
  DRAFT: 'draft',
  SUBMITTED: 'submitted',
  MANAGER_APPROVED: 'manager_approved',
  APPROVED: 'approved',
  REJECTED: 'rejected',
} as const;

export type ReportStatus = (typeof ReportStatus)[keyof typeof ReportStatus];

/** 訪問結果 */
export const VisitResult = {
  NEGOTIATING: 'negotiating',
  CLOSED_WON: 'closed_won',
  CLOSED_LOST: 'closed_lost',
  INFORMATION_GATHERING: 'information_gathering',
  OTHER: 'other',
} as const;

export type VisitResult = (typeof VisitResult)[keyof typeof VisitResult];

/** 承認アクション */
export const ApprovalAction = {
  APPROVED: 'approved',
  REJECTED: 'rejected',
} as const;

export type ApprovalAction =
  (typeof ApprovalAction)[keyof typeof ApprovalAction];

/** 承認レベル */
export const ApprovalLevel = {
  MANAGER: 'manager',
  DIRECTOR: 'director',
} as const;

export type ApprovalLevel = (typeof ApprovalLevel)[keyof typeof ApprovalLevel];
```

### 12.2 基本型定義

```typescript
/** 役職 */
export type Position = {
  id: number;
  name: string;
  level: number;
  createdAt: Date;
  updatedAt: Date;
};

/** 営業担当者 */
export type Salesperson = {
  id: number;
  name: string;
  email: string;
  positionId: number;
  managerId: number | null;
  directorId: number | null;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
};

/** 顧客 */
export type Customer = {
  id: number;
  name: string;
  address: string | null;
  phone: string | null;
  industry: string | null;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
};

/** 日報 */
export type DailyReport = {
  id: number;
  salespersonId: number;
  reportDate: Date;
  problem: string | null;
  plan: string | null;
  status: ReportStatus;
  submittedAt: Date | null;
  managerApprovedAt: Date | null;
  directorApprovedAt: Date | null;
  createdAt: Date;
  updatedAt: Date;
};

/** 訪問記録 */
export type VisitRecord = {
  id: number;
  dailyReportId: number;
  customerId: number;
  visitTime: Date | null;
  content: string;
  result: VisitResult | null;
  createdAt: Date;
  updatedAt: Date;
};

/** 添付ファイル */
export type Attachment = {
  id: number;
  visitRecordId: number;
  fileName: string;
  filePath: string;
  contentType: string;
  fileSize: number;
  createdAt: Date;
};

/** 承認履歴 */
export type ApprovalHistory = {
  id: number;
  dailyReportId: number;
  approverId: number;
  action: ApprovalAction;
  comment: string | null;
  approvalLevel: ApprovalLevel;
  createdAt: Date;
};

/** コメント */
export type Comment = {
  id: number;
  dailyReportId: number;
  commenterId: number;
  content: string;
  createdAt: Date;
  updatedAt: Date;
};
```

### 12.3 ネスト型定義（APIレスポンス用）

```typescript
/** 役職情報付き営業担当者 */
export type SalespersonWithPosition = Salesperson & {
  position: Position;
};

/** 上長情報付き営業担当者 */
export type SalespersonWithRelations = SalespersonWithPosition & {
  manager: Pick<Salesperson, 'id' | 'name'> | null;
  director: Pick<Salesperson, 'id' | 'name'> | null;
};

/** 顧客情報付き訪問記録 */
export type VisitRecordWithCustomer = VisitRecord & {
  customer: Pick<Customer, 'id' | 'name'>;
  attachments: Attachment[];
};

/** 詳細情報付き日報 */
export type DailyReportDetail = DailyReport & {
  salesperson: SalespersonWithPosition;
  visitRecords: VisitRecordWithCustomer[];
  approvalHistories: ApprovalHistoryWithApprover[];
  comments: CommentWithCommenter[];
};

/** 一覧用日報 */
export type DailyReportSummary = Pick<
  DailyReport,
  'id' | 'reportDate' | 'status' | 'submittedAt' | 'createdAt' | 'updatedAt'
> & {
  salesperson: Pick<Salesperson, 'id' | 'name'>;
  visitCount: number;
};
```

### 12.4 ページネーション型

```typescript
/** ページネーション情報 */
export type Pagination = {
  currentPage: number;
  perPage: number;
  totalPages: number;
  totalCount: number;
};

/** ページネーション付きリスト */
export type PaginatedList<T> = {
  items: T[];
  pagination: Pagination;
};
```

---

## 13. APIスキーマ定義

Zodによるリクエスト/レスポンスのバリデーションスキーマ。APIの入力検証とTypeScript型生成に使用。

ファイル: `src/schemas/api.ts`

### 13.1 Enumスキーマ

```typescript
import { z } from 'zod';

/** 日報ステータス */
export const reportStatusSchema = z.enum([
  'draft',
  'submitted',
  'manager_approved',
  'approved',
  'rejected',
]);

/** 訪問結果 */
export const visitResultSchema = z.enum([
  'negotiating',
  'closed_won',
  'closed_lost',
  'information_gathering',
  'other',
]);

/** 承認アクション */
export const approvalActionSchema = z.enum(['approved', 'rejected']);

/** 承認レベル */
export const approvalLevelSchema = z.enum(['manager', 'director']);
```

### 13.2 共通スキーマ

```typescript
/** ページネーションクエリ */
export const paginationQuerySchema = z.object({
  page: z.coerce.number().int().positive().default(1),
  per_page: z.coerce.number().int().min(1).max(100).default(20),
});

/** ソートクエリ */
export const sortQuerySchema = z.object({
  sort: z.string().optional(),
  order: z.enum(['asc', 'desc']).default('desc'),
});

/** ID パラメータ */
export const idParamSchema = z.object({
  id: z.coerce.number().int().positive(),
});
```

### 13.3 認証APIスキーマ

```typescript
/** ログインリクエスト */
export const loginRequestSchema = z.object({
  email: z.string().email('有効なメールアドレスを入力してください'),
  password: z.string().min(1, 'パスワードを入力してください'),
  remember: z.boolean().default(false),
});

/** トークンリフレッシュリクエスト */
export const refreshTokenRequestSchema = z.object({
  refresh_token: z.string().min(1),
});

/** ログインレスポンス */
export const loginResponseSchema = z.object({
  access_token: z.string(),
  refresh_token: z.string(),
  token_type: z.literal('Bearer'),
  expires_in: z.number(),
  user: z.object({
    id: z.number(),
    name: z.string(),
    email: z.string(),
    position: z.object({
      id: z.number(),
      name: z.string(),
      level: z.number(),
    }),
  }),
});
```

### 13.4 日報APIスキーマ

```typescript
/** 日報検索クエリ */
export const reportSearchQuerySchema = paginationQuerySchema
  .merge(sortQuerySchema)
  .extend({
    date_from: z.string().date().optional(),
    date_to: z.string().date().optional(),
    salesperson_id: z.coerce.number().int().positive().optional(),
    status: reportStatusSchema.optional(),
  });

/** 訪問記録入力 */
export const visitRecordInputSchema = z.object({
  customer_id: z.number().int().positive('顧客を選択してください'),
  visit_time: z
    .string()
    .regex(/^([01]\d|2[0-3]):([0-5]\d)$/, '時刻はHH:MM形式で入力してください')
    .optional()
    .nullable(),
  content: z
    .string()
    .min(1, '訪問内容を入力してください')
    .max(2000, '訪問内容は2000文字以内で入力してください'),
  result: visitResultSchema.optional().nullable(),
});

/** 日報作成リクエスト */
export const createReportRequestSchema = z.object({
  report_date: z.string().date('有効な日付を入力してください'),
  problem: z.string().max(2000).optional().nullable(),
  plan: z.string().max(2000).optional().nullable(),
  visits: z.array(visitRecordInputSchema).optional(),
});

/** 日報更新リクエスト */
export const updateReportRequestSchema = z.object({
  problem: z.string().max(2000).optional().nullable(),
  plan: z.string().max(2000).optional().nullable(),
});
```

### 13.5 承認APIスキーマ

```typescript
/** 承認リクエスト */
export const approveRequestSchema = z.object({
  comment: z.string().max(2000).optional(),
});

/** 差戻しリクエスト */
export const rejectRequestSchema = z.object({
  comment: z
    .string()
    .min(1, '差戻し理由を入力してください')
    .max(2000, '差戻し理由は2000文字以内で入力してください'),
});
```

### 13.6 コメントAPIスキーマ

```typescript
/** コメント作成リクエスト */
export const createCommentRequestSchema = z.object({
  content: z
    .string()
    .min(1, 'コメントを入力してください')
    .max(2000, 'コメントは2000文字以内で入力してください'),
});
```

### 13.7 顧客マスタAPIスキーマ

```typescript
/** 顧客検索クエリ */
export const customerSearchQuerySchema = paginationQuerySchema
  .merge(sortQuerySchema)
  .extend({
    name: z.string().optional(),
    industry: z.string().optional(),
    is_active: z
      .enum(['true', 'false'])
      .transform((v) => v === 'true')
      .optional(),
  });

/** 顧客作成リクエスト */
export const createCustomerRequestSchema = z.object({
  name: z.string().min(1, '顧客名を入力してください').max(200),
  address: z.string().max(500).optional().nullable(),
  phone: z
    .string()
    .max(20)
    .regex(/^[\d\-+()]*$/)
    .optional()
    .nullable(),
  industry: z.string().max(100).optional().nullable(),
});

/** 顧客更新リクエスト */
export const updateCustomerRequestSchema = createCustomerRequestSchema
  .partial()
  .extend({ is_active: z.boolean().optional() });
```

### 13.8 営業担当者マスタAPIスキーマ

```typescript
/** 営業担当者検索クエリ */
export const salespersonSearchQuerySchema = paginationQuerySchema.extend({
  name: z.string().optional(),
  position_id: z.coerce.number().int().positive().optional(),
  is_active: z
    .enum(['true', 'false'])
    .transform((v) => v === 'true')
    .optional(),
});

/** 営業担当者作成リクエスト */
export const createSalespersonRequestSchema = z.object({
  name: z.string().min(1, '氏名を入力してください').max(100),
  email: z.string().email('有効なメールアドレスを入力してください').max(255),
  position_id: z.number().int().positive('役職を選択してください'),
  manager_id: z.number().int().positive().optional().nullable(),
  director_id: z.number().int().positive().optional().nullable(),
  password: z
    .string()
    .min(8, 'パスワードは8文字以上で入力してください')
    .max(100),
});

/** 営業担当者更新リクエスト */
export const updateSalespersonRequestSchema = z.object({
  name: z.string().min(1).max(100).optional(),
  email: z.string().email().max(255).optional(),
  position_id: z.number().int().positive().optional(),
  manager_id: z.number().int().positive().optional().nullable(),
  director_id: z.number().int().positive().optional().nullable(),
  is_active: z.boolean().optional(),
  reset_password: z.boolean().optional(),
});
```

### 13.9 レスポンスラッパースキーマ

```typescript
/** 成功レスポンス */
export const successResponseSchema = <T extends z.ZodTypeAny>(dataSchema: T) =>
  z.object({
    success: z.literal(true),
    data: dataSchema,
  });

/** エラーレスポンス */
export const errorResponseSchema = z.object({
  success: z.literal(false),
  error: z.object({
    code: z.string(),
    message: z.string(),
  }),
});
```

### 13.10 型エクスポート

```typescript
// Zodスキーマから型を生成
export type LoginRequest = z.infer<typeof loginRequestSchema>;
export type LoginResponse = z.infer<typeof loginResponseSchema>;
export type CreateReportRequest = z.infer<typeof createReportRequestSchema>;
export type UpdateReportRequest = z.infer<typeof updateReportRequestSchema>;
export type VisitRecordInput = z.infer<typeof visitRecordInputSchema>;
export type ApproveRequest = z.infer<typeof approveRequestSchema>;
export type RejectRequest = z.infer<typeof rejectRequestSchema>;
export type CreateCommentRequest = z.infer<typeof createCommentRequestSchema>;
export type CreateCustomerRequest = z.infer<typeof createCustomerRequestSchema>;
export type UpdateCustomerRequest = z.infer<typeof updateCustomerRequestSchema>;
export type CreateSalespersonRequest = z.infer<
  typeof createSalespersonRequestSchema
>;
export type UpdateSalespersonRequest = z.infer<
  typeof updateSalespersonRequestSchema
>;
```

### 13.11 使用例

```typescript
import { createReportRequestSchema, type CreateReportRequest } from '@/schemas';

// バリデーション実行
const result = createReportRequestSchema.safeParse(requestBody);

if (!result.success) {
  // バリデーションエラー
  const errors = result.error.flatten();
  return {
    success: false,
    error: { code: 'VALIDATION_ERROR', message: errors },
  };
}

// 型安全なデータ
const validData: CreateReportRequest = result.data;
```

# 使用技術

**言語**　TypeScript
**フレームワーク**　Next.js(App Router)
**UIコンポーネント**　shadcm/ui + Tailwind CSS
**APIスキーマ定義**　OpenAPI(Zodによる検証)
**DBスキーマ定義**　Prisma.js
**テスト**　Vitest
**デプロイ**　docker container
