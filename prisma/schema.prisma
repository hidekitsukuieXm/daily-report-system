// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// Enums
// ========================================

/// 日報ステータス
enum ReportStatus {
  draft            @map("draft")             // 下書き
  submitted        @map("submitted")         // 提出済（課長承認待ち）
  manager_approved @map("manager_approved")  // 課長承認済（部長承認待ち）
  approved         @map("approved")          // 承認完了
  rejected         @map("rejected")          // 差戻し
}

/// 訪問結果
enum VisitResult {
  negotiating           @map("negotiating")           // 商談中
  closed_won            @map("closed_won")            // 成約
  closed_lost           @map("closed_lost")           // 見送り
  information_gathering @map("information_gathering") // 情報収集
  other                 @map("other")                 // その他
}

/// 承認アクション
enum ApprovalAction {
  approved @map("approved") // 承認
  rejected @map("rejected") // 差戻し
}

/// 承認レベル
enum ApprovalLevel {
  manager  @map("manager")  // 課長
  director @map("director") // 部長
}

// ========================================
// Models
// ========================================

/// 役職マスタ
model Position {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(50)  // 役職名（担当/課長/部長）
  level     Int                        // 階層レベル（1:担当/2:課長/3:部長）
  createdAt DateTime @default(now())   @map("created_at")
  updatedAt DateTime @updatedAt        @map("updated_at")

  // Relations
  salespersons Salesperson[]

  @@map("positions")
}

/// 営業担当者マスタ
model Salesperson {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(100)  // 氏名
  email      String   @unique @db.VarChar(255) // メールアドレス
  password   String   @db.VarChar(255)  // パスワード（ハッシュ化）
  positionId Int      @map("position_id")
  managerId  Int?     @map("manager_id")  // 直属上長ID（課長）
  directorId Int?     @map("director_id") // 2次上長ID（部長）
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt      @map("updated_at")

  // Relations
  position         Position          @relation(fields: [positionId], references: [id])
  manager          Salesperson?      @relation("ManagerSubordinates", fields: [managerId], references: [id])
  director         Salesperson?      @relation("DirectorSubordinates", fields: [directorId], references: [id])
  subordinates     Salesperson[]     @relation("ManagerSubordinates")  // 部下（課長として）
  teamMembers      Salesperson[]     @relation("DirectorSubordinates") // 部下（部長として）
  dailyReports     DailyReport[]
  comments         Comment[]
  approvalHistories ApprovalHistory[]

  @@index([positionId])
  @@index([managerId])
  @@index([directorId])
  @@map("salespersons")
}

/// 顧客マスタ
model Customer {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(200)  // 顧客名
  address   String?  @db.VarChar(500)  // 住所
  phone     String?  @db.VarChar(20)   // 電話番号
  industry  String?  @db.VarChar(100)  // 業種
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  // Relations
  visitRecords VisitRecord[]

  @@map("customers")
}

/// 日報
model DailyReport {
  id                 Int           @id @default(autoincrement())
  salespersonId      Int           @map("salesperson_id")
  reportDate         DateTime      @map("report_date") @db.Date // 報告日
  problem            String?       @db.Text  // 課題・相談
  plan               String?       @db.Text  // 明日やること
  status             ReportStatus  @default(draft)
  submittedAt        DateTime?     @map("submitted_at")          // 提出日時
  managerApprovedAt  DateTime?     @map("manager_approved_at")   // 課長承認日時
  directorApprovedAt DateTime?     @map("director_approved_at")  // 部長承認日時
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt      @map("updated_at")

  // Relations
  salesperson       Salesperson       @relation(fields: [salespersonId], references: [id])
  visitRecords      VisitRecord[]
  comments          Comment[]
  approvalHistories ApprovalHistory[]

  @@unique([salespersonId, reportDate]) // 同一担当者・同一日付の日報は1件のみ
  @@index([salespersonId])
  @@index([reportDate])
  @@index([status])
  @@map("daily_reports")
}

/// 訪問記録
model VisitRecord {
  id            Int          @id @default(autoincrement())
  dailyReportId Int          @map("daily_report_id")
  customerId    Int          @map("customer_id")
  visitTime     DateTime?    @map("visit_time") @db.Time // 訪問時刻
  content       String       @db.Text  // 訪問内容
  result        VisitResult? // 結果
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt      @map("updated_at")

  // Relations
  dailyReport DailyReport  @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  customer    Customer     @relation(fields: [customerId], references: [id])
  attachments Attachment[]

  @@index([dailyReportId])
  @@index([customerId])
  @@map("visit_records")
}

/// 添付ファイル
model Attachment {
  id            Int      @id @default(autoincrement())
  visitRecordId Int      @map("visit_record_id")
  fileName      String   @map("file_name") @db.VarChar(255)  // ファイル名
  filePath      String   @map("file_path") @db.VarChar(500)  // 保存パス
  contentType   String   @map("content_type") @db.VarChar(100) // MIMEタイプ
  fileSize      Int      @map("file_size")  // ファイルサイズ（バイト）
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  visitRecord VisitRecord @relation(fields: [visitRecordId], references: [id], onDelete: Cascade)

  @@index([visitRecordId])
  @@map("attachments")
}

/// 承認履歴
model ApprovalHistory {
  id            Int           @id @default(autoincrement())
  dailyReportId Int           @map("daily_report_id")
  approverId    Int           @map("approver_id")
  action        ApprovalAction // 承認/差戻し
  comment       String?       @db.Text  // コメント
  approvalLevel ApprovalLevel @map("approval_level") // 課長/部長
  createdAt     DateTime      @default(now()) @map("created_at")

  // Relations
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  approver    Salesperson @relation(fields: [approverId], references: [id])

  @@index([dailyReportId])
  @@index([approverId])
  @@map("approval_histories")
}

/// コメント
model Comment {
  id            Int      @id @default(autoincrement())
  dailyReportId Int      @map("daily_report_id")
  commenterId   Int      @map("commenter_id")
  content       String   @db.Text  // コメント内容
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt      @map("updated_at")

  // Relations
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  commenter   Salesperson @relation(fields: [commenterId], references: [id])

  @@index([dailyReportId])
  @@index([commenterId])
  @@map("comments")
}
